<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VITALIUM PRO | Ritmik Destek</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#FF1744">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vitalium PRO">
    <link rel="apple-touch-icon" id="appleTouchIcon" sizes="192x192" href="">
    <link rel="apple-touch-icon-precomposed" id="appleTouchIconPre" sizes="192x192" href="">
    <script>
    (function() {
        function drawIcon(size) {
            try {
                var c = document.createElement('canvas');
                c.width = size; c.height = size;
                var ctx = c.getContext('2d');
                var r = Math.round(size * 0.22);
                ctx.beginPath();
                ctx.moveTo(r, 0); ctx.lineTo(size - r, 0);
                ctx.arcTo(size, 0, size, r, r);
                ctx.lineTo(size, size - r);
                ctx.arcTo(size, size, size - r, size, r);
                ctx.lineTo(r, size);
                ctx.arcTo(0, size, 0, size - r, r);
                ctx.lineTo(0, r);
                ctx.arcTo(0, 0, r, 0, r);
                ctx.closePath();
                var grad = ctx.createLinearGradient(0, 0, size, size);
                grad.addColorStop(0, '#e11d48');
                grad.addColorStop(1, '#be123c');
                ctx.fillStyle = grad;
                ctx.fill();
                ctx.save();
                ctx.translate(size * 0.5, size * 0.53);
                var h = size * 0.36;
                ctx.beginPath();
                ctx.moveTo(0, h * 0.35);
                ctx.bezierCurveTo(-h * 0.1, h * 0.1, -h * 0.7, -h * 0.4, -h, 0);
                ctx.bezierCurveTo(-h * 1.35, h * 0.5, 0, h * 1.05, 0, h * 1.05);
                ctx.bezierCurveTo(0, h * 1.05, h * 1.35, h * 0.5, h, 0);
                ctx.bezierCurveTo(h * 0.7, -h * 0.4, h * 0.1, h * 0.1, 0, h * 0.35);
                ctx.closePath();
                ctx.fillStyle = '#ffffff';
                ctx.shadowColor = 'rgba(0,0,0,0.25)';
                ctx.shadowBlur = size * 0.05;
                ctx.fill();
                ctx.restore();
                return c.toDataURL('image/png');
            } catch(e) { return ''; }
        }

        var png192 = drawIcon(192);
        var png512 = drawIcon(512);
        window._pwaIcons = { png192: png192, png512: png512 };

        if (png192) {
            var links = document.querySelectorAll('link[rel="apple-touch-icon"], link[rel="apple-touch-icon-precomposed"]');
            for (var i = 0; i < links.length; i++) { links[i].href = png192; }
        }
    })();
    </script>
    <style>
        :root {
            --bg: #000000;
            --bg2: #0a0a0a;
            --surface: #111111;
            --surface2: #1a1a1a;
            --surface3: #222222;
            --text: #ffffff;
            --text2: #e0e0e0;
            --sub: #666666;
            --sub2: #444444;
            --border: rgba(255,255,255,0.07);
            --border2: rgba(255,255,255,0.12);
            --accent: #FF1744;
            --accent-dim: rgba(255,23,68,0.12);
            --accent-glow: rgba(255,23,68,0.25);
            --blue: #00B4D8;
            --blue-dim: rgba(0,180,216,0.12);
            --green: #00E676;
            --green-dim: rgba(0,230,118,0.1);
            --yellow: #FFD600;
            --orange: #FF6D00;
            --purple: #D500F9;
            --mono: 'DM Mono', monospace;
            --font-scale: 1;
            --nav-h: 68px;
            --header-h: 58px;
        }

        body.light-mode {
            --bg: #f5f5f5; --bg2: #eeeeee; --surface: #ffffff; --surface2: #f8f8f8;
            --surface3: #efefef; --text: #0a0a0a; --text2: #1a1a1a;
            --sub: #888888; --sub2: #aaaaaa; --border: rgba(0,0,0,0.08);
            --border2: rgba(0,0,0,0.14); --accent-dim: rgba(255,23,68,0.07);
            --accent-glow: rgba(255,23,68,0.15); --blue-dim: rgba(0,180,216,0.07);
            --green-dim: rgba(0,230,118,0.07);
        }
        body.light-mode header {
            background: rgba(255,255,255,0.92);
            border-bottom-color: rgba(0,0,0,0.1);
        }
        body.light-mode .nav-bar {
            background: rgba(255,255,255,0.94);
            box-shadow: 0 -1px 0 rgba(0,0,0,0.1);
        }
        /* Acil aksiyon butonları - light mode */
        body.light-mode .btn-sos {
            background: #ffe4e9;
            border-color: rgba(200,0,40,0.35);
            box-shadow: 0 2px 8px rgba(200,0,40,0.12);
        }
        body.light-mode .btn-sos,
        body.light-mode .btn-sos .btn-label { color: #b8001e; }
        body.light-mode .btn-quick {
            background: #ddf4ff;
            border-color: rgba(0,150,200,0.35);
            box-shadow: 0 2px 8px rgba(0,150,200,0.12);
        }
        body.light-mode .btn-quick,
        body.light-mode .btn-quick .btn-label { color: #005070; }
        body.light-mode .btn-whistle {
            background: #fff8d6;
            border-color: rgba(200,160,0,0.4);
            box-shadow: 0 2px 8px rgba(200,160,0,0.12);
        }
        body.light-mode .btn-whistle,
        body.light-mode .btn-whistle .btn-label { color: #7a5000; }
        body.light-mode .btn-blood {
            background: #f5e6ff;
            border-color: rgba(170,0,210,0.3);
            box-shadow: 0 2px 8px rgba(170,0,210,0.1);
        }
        body.light-mode .btn-blood,
        body.light-mode .btn-blood .btn-label { color: #7b1fa2; }
        /* Kontak butonları - light mode */
        body.light-mode .c-red    { background: #ffe4e9; border-color: rgba(200,0,40,0.35);   color: #b8001e; }
        body.light-mode .c-orange { background: #ffe8d6; border-color: rgba(200,80,0,0.35);   color: #923500; }
        body.light-mode .c-yellow { background: #fff8d0; border-color: rgba(180,130,0,0.35);  color: #6b4400; }
        body.light-mode .c-blue   { background: #ddf4ff; border-color: rgba(0,150,200,0.35);  color: #004a6e; }
        body.light-mode .c-green  { background: #dcfff0; border-color: rgba(0,170,90,0.35);   color: #005028; }
        /* Hastane / navigasyon butonları - light mode */
        body.light-mode .hosp-btn {
            background: #dcfff0; color: #005028;
            border-color: rgba(0,170,90,0.4);
        }
        body.light-mode .hosp-nav-btn {
            background: #dcfff0; color: #005028;
            border-color: rgba(0,170,90,0.35);
        }
        /* Metronom butonları - light mode */
        body.light-mode .metro-start { background: #dcfff0; color: #005028; border-color: rgba(0,170,90,0.35); }
        body.light-mode .metro-stop  { background: #ffe4e9; color: #b8001e; border-color: rgba(200,0,40,0.3); }
        /* Ses & diğer butonlar - light mode */
        body.light-mode .voice-btn {
            background: #ddf4ff; color: #004a6e;
            border-color: rgba(0,150,200,0.35);
        }
        body.light-mode .sheet-close-btn {
            background: #ffe4e9; color: #b8001e;
            border-color: rgba(200,0,40,0.3);
        }
        body.light-mode .install-btn {
            background: #f5e6ff; color: #6a0080;
            border-color: rgba(170,0,210,0.3);
        }
        body.light-mode .tab-indicator { background: var(--accent); }
        body.light-mode .card-grid-item { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        body.light-mode .card-grid-item:hover { box-shadow: 0 4px 20px var(--accent-glow); }
        body.light-mode .stat-card { background: #fff; border-color: rgba(0,0,0,0.07); }
        body.light-mode .ecg-line { opacity: 0.15; }
        body.light-mode #medNotes { background: #fff; border-color: rgba(0,0,0,0.12); color: #0a0a0a; }
        body.light-mode #quakeBox { background: rgba(255,23,68,0.03); }
        body.light-mode .blood-option, body.light-mode .rh-option { background: #f5f5f5; border-color: rgba(0,0,0,0.12); color: #0a0a0a; }
        body.light-mode .modal { box-shadow: 0 8px 40px rgba(0,0,0,0.18); }
        body.light-mode .important-note { background: #fff3f5; color: #1a1a1a; }
        body.light-mode .sheet { background: #fff; box-shadow: 0 -4px 24px rgba(0,0,0,0.12); }
        body.light-mode .hosp-type-btn { background: #f5f5f5; border-color: rgba(0,0,0,0.1); color: #0a0a0a; }
        body.light-mode .hosp-type-btn.active { background: rgba(0,230,118,0.1); border-color: var(--green); color: #004d26; }
        body.light-mode .hosp-card { background: rgba(0,230,118,0.05); border-color: rgba(0,230,118,0.2); }
        body.light-mode #searchInput { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        body.light-mode .pulse-stat { background: #f5f5f5; border-color: rgba(0,0,0,0.06); }
        body.light-mode .pulse-reset { background: #f5f5f5; border-color: rgba(0,0,0,0.1); color: #666; }
        body.light-mode .metro-ring { border-color: rgba(0,0,0,0.12); }
        body.light-mode .metro-reset-btn { background: #f5f5f5; border-color: rgba(0,0,0,0.1); color: #666; }
        body.light-mode .nav-item.active .nav-label { color: var(--accent); }
        body.light-mode #toast { background: #1a1a1a; color: #fff; }
        body.light-mode .contact-btn { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        body.light-mode .toggle-track { background: #ccc; border-color: #aaa; }

        body.high-contrast {
            --bg: #000000; --surface: #050505; --text: #ffffff;
            --sub: #ffff00; --border: rgba(255,255,255,0.4); --accent: #ff3366;
            --blue: #44aaff; --green: #00ff88;
        }

        body.colorblind-mode { filter: url('#colorblind-filter'); }

        body.reduce-motion *,
        body.reduce-motion *::before,
        body.reduce-motion *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        body.big-touch .action-btn { padding: 22px 8px; font-size: .88rem; }
        body.big-touch .card-grid-item { padding: 28px 12px; }
        body.big-touch button { min-height: 54px; }

        *, *::before, *::after {
            box-sizing: border-box; margin: 0; padding: 0;
            font-family: 'Sora', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            min-height: 100vh;
            font-size: calc(1rem * var(--font-scale));
        }

        .ecg-decoration {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 0; overflow: hidden;
        }
        .ecg-line {
            position: absolute; top: 50%; width: 200%;
            height: 1px; opacity: 0.04;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px, transparent 40px,
                var(--accent) 40px, var(--accent) 42px,
                transparent 42px, transparent 80px,
                var(--accent) 80px, var(--accent) 90px,
                transparent 90px, transparent 94px,
                var(--accent) 94px, var(--accent) 96px,
                transparent 96px
            );
            animation: ecgScroll 8s linear infinite;
        }
        @keyframes ecgScroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        #breakingNews {
            display: none; position: fixed; top: 0; left: 0; right: 0;
            z-index: 9000; background: var(--accent);
            padding: 12px 15px; color: white; font-weight: 800;
            font-size: .85rem; text-align: center;
            animation: slideDown .35s ease-out;
            font-family: var(--mono); letter-spacing: .5px;
            text-transform: uppercase;
        }
        #breakingNews.active { display: block; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            height: var(--header-h);
            background: rgba(0,0,0,0.92);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            transition: top .3s, background .3s;
        }
        header.news-active { top: 42px; }
        header.offline-active { top: 40px; }
        header.news-active.offline-active { top: 82px; }
        .header-brand {
            display: flex; align-items: center; gap: 10px;
        }
        .brand-icon {
            width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .logo-heart {
            animation: heartBeat 1.8s ease-in-out infinite;
            transform-origin: 50% 55%;
        }
        @keyframes heartBeat {
            0%,100% { transform: scale(1); }
            14% { transform: scale(1.12); }
            28% { transform: scale(1.05); }
            42% { transform: scale(1.13); }
            70% { transform: scale(1); }
        }
        .logo-ecg {
            stroke-dasharray: 120;
            stroke-dashoffset: 120;
            animation: ecgDraw 1.8s ease-in-out infinite;
        }
        @keyframes ecgDraw {
            0% { stroke-dashoffset: 120; opacity: 0; }
            15% { opacity: 1; }
            55% { stroke-dashoffset: 0; opacity: 1; }
            80% { stroke-dashoffset: 0; opacity: .7; }
            100% { stroke-dashoffset: -120; opacity: 0; }
        }
        .brand-text {
            font-weight: 800; font-size: 1.05rem; letter-spacing: -.3px;
            color: var(--text);
        }
        .brand-text span { color: var(--accent); }
        .brand-badge {
            font-family: var(--mono); font-size: .58rem; font-weight: 500;
            color: var(--sub); letter-spacing: 1.5px; text-transform: uppercase;
            display: block; margin-top: -2px;
        }
        .header-actions { display: flex; align-items: center; gap: 6px; }
        .hdr-btn {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text2); border-radius: 10px; padding: 7px 10px;
            cursor: pointer; transition: .2s;
            font-family: var(--mono); font-size: .7rem; font-weight: 500;
        }
        .hdr-btn:hover { border-color: var(--border2); background: var(--surface2); }
        .status-pill {
            display: flex; align-items: center; gap: 5px;
            font-family: var(--mono); font-size: .6rem; font-weight: 500;
            color: var(--green); letter-spacing: .5px;
        }
        .status-dot {
            width: 6px; height: 6px; background: var(--green);
            border-radius: 50%; animation: dotPulse 1.8s ease-in-out infinite;
        }
        @keyframes dotPulse { 0%,100% { opacity: 1; } 50% { opacity: .25; } }

        .app-content {
            position: relative; z-index: 1;
            padding-top: var(--header-h);
            padding-bottom: calc(var(--nav-h) + 12px);
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
            height: var(--nav-h);
            background: rgba(0,0,0,0.94);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid var(--border);
            display: flex; align-items: center;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .nav-items {
            display: flex; flex: 1; height: 100%;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 4px; cursor: pointer; border: none;
            background: transparent; color: var(--sub);
            transition: color .2s, transform .15s;
            padding: 8px 4px;
            position: relative;
        }
        .nav-item:active { transform: scale(.9); }
        .nav-icon { font-size: 1.25rem; line-height: 1; }
        .nav-label {
            font-size: .55rem; font-weight: 700; letter-spacing: .8px;
            text-transform: uppercase; font-family: var(--mono);
            transition: color .2s;
        }
        .nav-item.active { color: var(--accent); }
        .nav-item.active .nav-label { color: var(--accent); }
        .nav-active-dot {
            position: absolute; top: 8px; width: 4px; height: 4px;
            background: var(--accent); border-radius: 50%;
            opacity: 0; transition: opacity .2s;
        }
        .nav-item.active .nav-active-dot { opacity: 1; }

        .section-head {
            padding: 20px 16px 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .section-title-text {
            font-family: var(--mono); font-size: .65rem; font-weight: 500;
            color: var(--sub); letter-spacing: 2px; text-transform: uppercase;
        }
        .section-line {
            flex: 1; height: 1px; background: var(--border); margin-left: 12px;
        }

        .emergency-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; padding: 12px 16px 0;
        }
        .action-btn {
            border: none; padding: 18px 8px; border-radius: 16px;
            font-weight: 800; cursor: pointer; font-size: .72rem;
            display: flex; flex-direction: column; align-items: center;
            gap: 7px; color: white; transition: opacity .2s, transform .12s, box-shadow .2s;
            position: relative; overflow: hidden;
            font-family: 'Sora', sans-serif; letter-spacing: .3px;
        }
        .action-btn::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, transparent 60%);
        }
        .action-btn:active { transform: scale(.94); opacity: .8; }
        .action-btn .btn-icon { font-size: 1.5rem; line-height: 1; }
        .action-btn .btn-label { font-weight: 800; font-size: .7rem; letter-spacing: .5px; }
        .btn-sos {
            background: #1f0509;
            border: 1px solid rgba(255,23,68,0.35);
            color: #FF5370;
            box-shadow: inset 0 1px 0 rgba(255,23,68,0.15);
        }
        .btn-sos .btn-label { color: #FF5370; }
        .btn-quick {
            background: #041218;
            border: 1px solid rgba(0,180,216,0.3);
            color: #4DD0E1;
            box-shadow: inset 0 1px 0 rgba(0,180,216,0.12);
        }
        .btn-quick .btn-label { color: #4DD0E1; }
        .btn-whistle {
            background: #141000;
            border: 1px solid rgba(255,214,0,0.28);
            color: #FFD740;
        }
        .btn-whistle .btn-label { color: #FFD740; }
        .btn-blood {
            background: #120020;
            border: 1px solid rgba(213,0,249,0.28);
            color: #CE93D8;
            box-shadow: inset 0 1px 0 rgba(213,0,249,0.1);
        }
        .btn-blood .btn-label { color: #CE93D8; }

        .contacts-box {
            margin: 0 16px; padding: 16px;
            background: var(--surface); border-radius: 18px;
            border: 1px solid var(--border);
        }
        .contacts-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 8px; margin-bottom: 14px;
        }
        .contact-btn {
            padding: 13px 8px; border: 1px solid; border-radius: 13px;
            font-weight: 700; font-size: .8rem; cursor: pointer;
            transition: transform .12s, opacity .15s;
            font-family: 'Sora', sans-serif;
        }
        .contact-btn:active { transform: scale(.95); opacity: .8; }
        .c-red { background: #1a0306; border-color: rgba(255,23,68,.25); color: #FF5370; }
        .c-orange { background: #1a0800; border-color: rgba(255,109,0,.25); color: #FF8A50; }
        .c-yellow { background: #161000; border-color: rgba(255,214,0,.22); color: #FFD740; }
        .c-blue { background: #001018; border-color: rgba(0,180,216,.25); color: #4DD0E1; }
        .c-green { background: #001409; border-color: rgba(0,230,118,.25); color: #69F0AE; }
        .custom-contacts-label {
            font-family: var(--mono); font-size: .6rem; color: var(--sub);
            letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px;
            display: block;
        }
        .add-contact-btn {
            width: 100%; padding: 10px; border: 1px dashed var(--border2);
            background: transparent; color: var(--accent); border-radius: 10px;
            font-weight: 700; cursor: pointer; font-size: .82rem;
            transition: border-color .2s, background .2s;
        }
        .add-contact-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

        .health-duo {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; padding: 0 16px;
        }
        .health-card {
            background: var(--surface); border-radius: 18px;
            border: 1px solid var(--border); padding: 16px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .health-card-title {
            font-size: .75rem; font-weight: 700; letter-spacing: .3px;
        }
        .metro-ring {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px solid var(--border2); margin: 0 auto;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; position: relative; transition: border-color .15s;
        }
        .metro-ring.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 0 var(--accent-glow);
            animation: metroPing .55s infinite;
        }
        @keyframes metroPing {
            0% { box-shadow: 0 0 0 0 rgba(255,23,68,.4); }
            70% { box-shadow: 0 0 0 14px rgba(255,23,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,23,68,0); }
        }
        .metro-bpm { font-family: var(--mono); font-size: 1.4rem; font-weight: 500; color: var(--accent); }
        .metro-lbl { font-family: var(--mono); font-size: .52rem; color: var(--sub); letter-spacing: 1px; }
        .metro-counter {
            text-align: center; font-family: var(--mono); font-size: 2.2rem;
            font-weight: 500; color: var(--text); transition: color .1s;
        }
        .metro-counter.flash { color: var(--accent); }
        .metro-sub { text-align: center; font-size: .65rem; color: var(--sub); line-height: 1.4; }
        .metro-btn {
            width: 100%; padding: 11px; border-radius: 12px; border: none;
            font-weight: 800; font-size: .75rem; cursor: pointer; transition: .15s;
            font-family: 'Sora', sans-serif;
        }
        .metro-start { background: #001409; color: #69F0AE; border: 1px solid rgba(0,230,118,.25); }
        .metro-stop { background: #1a0305; color: #FF5370; border: 1px solid rgba(255,23,68,.25); display: none; }
        .metro-reset-btn {
            background: var(--surface2); color: var(--sub);
            border: 1px solid var(--border); border-radius: 12px;
            width: 100%; padding: 11px; font-weight: 700; font-size: .75rem;
            cursor: pointer; transition: .15s;
        }
        .metro-reset-btn:hover { color: var(--text); }

        .pulse-tap-btn {
            width: 100%; padding: 18px 8px; border-radius: 16px;
            border: 2px solid var(--accent); background: var(--accent-dim);
            color: var(--accent); font-size: 1rem; font-weight: 900;
            cursor: pointer; transition: background .1s, transform .1s;
            position: relative; overflow: hidden;
        }
        .pulse-tap-btn:active { background: rgba(255,23,68,.2); transform: scale(.97); }
        .pulse-tap-btn.beat { animation: tapBeat .15s ease-out; }
        @keyframes tapBeat { 0% { transform: scale(.97); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        .pulse-stat {
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 10px; padding: 8px; text-align: center; flex: 1;
        }
        .pulse-stat-val { font-family: var(--mono); font-size: 1.2rem; font-weight: 500; color: var(--accent); }
        .pulse-stat-lbl { font-family: var(--mono); font-size: .55rem; color: var(--sub); margin-top: 2px; letter-spacing: .8px; text-transform: uppercase; }
        .pulse-stats-row { display: flex; gap: 6px; }
        .pulse-reset {
            background: transparent; border: 1px solid var(--border);
            color: var(--sub); border-radius: 8px; padding: 5px 10px;
            font-size: .68rem; cursor: pointer;
        }

        .firstaid-box {
            margin: 0 16px; background: var(--surface);
            border-radius: 18px; border: 1px solid var(--border); padding: 14px;
            display: flex; flex-direction: column; gap: 7px;
        }
        .fa-pill {
            padding: 10px 12px; border-radius: 11px;
            display: flex; align-items: flex-start; gap: 10px;
        }
        .fa-pill-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 1px; }
        .fa-pill-title { font-weight: 800; font-size: .78rem; color: var(--text); }
        .fa-pill-desc { font-size: .72rem; color: var(--sub); margin-top: 2px; line-height: 1.35; }

        .hosp-box {
            margin: 0 16px; background: var(--surface);
            border-radius: 18px; border: 1px solid var(--border); padding: 14px;
        }
        .hosp-btn {
            width: 100%; padding: 14px; border-radius: 13px;
            border: 1px solid rgba(0,230,118,.2);
            font-weight: 800; font-size: .88rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            color: #69F0AE; background: #001409;
            transition: transform .15s, opacity .15s, border-color .2s;
            font-family: 'Sora', sans-serif;
        }
        .hosp-btn:active { transform: scale(.97); opacity: .9; }
        .hosp-btn:hover { border-color: rgba(0,230,118,.35); }
        .hosp-type-grid { display: flex; flex-direction: column; gap: 6px; margin: 10px 0; }
        .hosp-type-btn {
            padding: 9px 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--surface2); color: var(--text); font-weight: 700;
            font-size: .78rem; cursor: pointer; text-align: left;
            transition: .15s; display: flex; align-items: center; gap: 8px;
        }
        .hosp-type-btn:hover { border-color: var(--green); background: var(--green-dim); }
        .hosp-type-btn.active { border-color: var(--green); background: var(--green-dim); color: var(--green); }
        .hosp-card {
            padding: 11px; border-radius: 11px; background: var(--green-dim);
            border: 1px solid rgba(0,230,118,.2); display: flex;
            justify-content: space-between; align-items: center; gap: 10px;
        }
        .hosp-nav-btn {
            padding: 9px 13px; border-radius: 9px;
            border: 1px solid rgba(0,230,118,.2);
            background: #001409; color: #69F0AE; font-weight: 700;
            font-size: .75rem; cursor: pointer; white-space: nowrap; flex-shrink: 0;
        }
        .hosp-name { font-weight: 800; font-size: .85rem; margin-bottom: 2px; }
        .hosp-dist { font-size: .72rem; color: var(--sub); font-family: var(--mono); }

        .search-wrap { padding: 12px 16px 0; position: relative; }
        #searchInput {
            width: 100%; padding: 12px 16px 12px 44px;
            border-radius: 14px; border: 1px solid var(--border);
            background: var(--surface); color: var(--text);
            font-size: .9rem; outline: none; transition: border-color .2s;
            font-family: 'Sora', sans-serif;
        }
        #searchInput:focus { border-color: var(--blue); }
        #searchInput::placeholder { color: var(--sub); }
        .search-icon-inner {
            position: absolute; left: 30px; top: 50%; transform: translateY(-50%);
            font-size: .95rem; pointer-events: none;
        }

        main#appGrid {
            padding: 10px 16px 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px,1fr));
            gap: 10px;
        }
        .card-grid-item {
            background: var(--surface); padding: 22px 12px;
            border-radius: 18px; border: 1px solid var(--border);
            cursor: pointer; text-align: center;
            transition: transform .15s, border-color .15s, box-shadow .15s;
            user-select: none;
        }
        .card-grid-item:hover { border-color: rgba(255,23,68,.3); box-shadow: 0 4px 20px var(--accent-dim); }
        .card-grid-item:active { transform: scale(.94); }
        .card-grid-item.hidden { display: none; }
        .card-emoji { font-size: 2.4rem; line-height: 1; margin-bottom: 10px; }
        .card-title { font-weight: 800; font-size: .88rem; line-height: 1.3; color: var(--text); }
        #noResult { display: none; text-align: center; padding: 40px; color: var(--sub); font-size: .9rem; }

        #quakeBox {
            margin: 0 16px; padding: 16px;
            background: var(--surface); border-radius: 18px;
            border: 1px solid rgba(255,23,68,.15);
        }
        .q-mag { font-weight: 800; font-family: var(--mono); margin-right: 8px; padding: 2px 7px; border-radius: 6px; font-size: .78rem; }
        .q-mag-low    { background: rgba(0,230,118,.12); color: var(--green); }
        .q-mag-mid    { background: rgba(255,214,0,.12); color: var(--yellow); }
        .q-mag-high   { background: rgba(255,109,0,.14); color: var(--orange); }
        .q-mag-severe { background: rgba(255,23,68,.14);  color: var(--accent); }
        .q-time { font-family: var(--mono); font-size: .72rem; color: var(--sub); }
        body.light-mode .q-mag-low    { background: rgba(0,150,80,.12); color: #005028; }
        body.light-mode .q-mag-mid    { background: rgba(180,130,0,.12); color: #6b4400; }
        body.light-mode .q-mag-high   { background: rgba(200,70,0,.14);  color: #923500; }
        body.light-mode .q-mag-severe { background: rgba(200,0,40,.14);  color: #b8001e; }

        /* Büyüklük skalası */
        .quake-scale-bar {
            display: flex; gap: 6px; padding: 12px 16px 0;
            align-items: center; justify-content: space-around;
        }
        .quake-scale-item { display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .qsc { font-family: var(--mono); font-weight: 800; font-size: .72rem; padding: 4px 10px; border-radius: 8px; }
        .qsc-low    { background: rgba(0,230,118,.12); color: var(--green); border: 1px solid rgba(0,230,118,.2); }
        .qsc-mid    { background: rgba(255,214,0,.1);  color: var(--yellow); border: 1px solid rgba(255,214,0,.2); }
        .qsc-high   { background: rgba(255,109,0,.12); color: var(--orange); border: 1px solid rgba(255,109,0,.2); }
        .qsc-severe { background: rgba(255,23,68,.12); color: var(--accent); border: 1px solid rgba(255,23,68,.2); }
        .qsc-lbl    { font-size: .58rem; color: var(--sub); font-family: var(--mono); letter-spacing: .5px; }
        body.light-mode .qsc-low    { background: rgba(0,150,80,.1); color: #005028; border-color: rgba(0,150,80,.25); }
        body.light-mode .qsc-mid    { background: rgba(180,130,0,.1); color: #6b4400; border-color: rgba(180,130,0,.25); }
        body.light-mode .qsc-high   { background: rgba(200,70,0,.1); color: #923500; border-color: rgba(200,70,0,.25); }
        body.light-mode .qsc-severe { background: rgba(200,0,40,.1); color: #b8001e; border-color: rgba(200,0,40,.25); }

        /* Deprem anında rehber kartları */
        .quake-guide-cards {
            margin: 0 16px;
            display: flex; flex-direction: column; gap: 7px;
        }
        .quake-guide-card {
            background: var(--surface); border-radius: 13px;
            border: 1px solid var(--border); border-left-width: 3px;
            padding: 11px 13px; display: flex; align-items: center; gap: 12px;
        }
        .qgc-step {
            width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: .78rem;
        }
        .qgc-title { font-weight: 800; font-size: .78rem; color: var(--text); margin-bottom: 2px; }
        .qgc-desc  { font-size: .72rem; color: var(--sub); line-height: 1.35; }

        #medicalBox {
            margin: 0 16px; padding: 16px;
            background: var(--surface); border-radius: 18px;
            border: 1px solid var(--border);
        }
        #medNotes {
            width: 100%; height: 100px;
            background: var(--surface2); border: 1px solid var(--border);
            color: var(--text); padding: 12px; border-radius: 12px;
            resize: none; font-size: .85rem; margin-top: 10px;
            line-height: 1.5; font-family: 'Sora', sans-serif;
        }
        #medNotes:focus { outline: none; border-color: var(--blue); }

        .profile-section {
            margin: 0 16px; background: var(--surface);
            border-radius: 18px; border: 1px solid var(--border);
            overflow: hidden;
        }
        .profile-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 16px; border-bottom: 1px solid var(--border);
        }
        .profile-row:last-child { border-bottom: none; }
        .profile-row-left { display: flex; align-items: center; gap: 12px; }
        .profile-row-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; flex-shrink: 0;
        }
        .p-label { font-weight: 700; font-size: .88rem; }
        .p-desc { font-size: .72rem; color: var(--sub); margin-top: 2px; }
        .chevron { color: var(--sub); font-size: .8rem; }
        .profile-action-btn {
            background: var(--surface2); border: 1px solid var(--border2);
            color: var(--text); border-radius: 10px; padding: 7px 14px;
            font-size: .78rem; font-weight: 700; cursor: pointer; transition: .15s;
            font-family: 'Sora', sans-serif;
        }

        .toggle-sw { position: relative; width: 48px; height: 26px; flex-shrink: 0; }
        .toggle-sw input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-track {
            position: absolute; inset: 0; background: var(--surface3);
            border-radius: 50px; cursor: pointer; transition: .25s;
            border: 1px solid var(--border2);
        }
        .toggle-track::after {
            content: ''; position: absolute; left: 3px; top: 50%;
            transform: translateY(-50%); width: 18px; height: 18px;
            border-radius: 50%; background: var(--sub); transition: .25s;
        }
        .toggle-sw input:checked + .toggle-track { background: var(--accent); border-color: var(--accent); }
        .toggle-sw input:checked + .toggle-track::after { transform: translateX(22px) translateY(-50%); background: #fff; }

        .font-slider { width: 100%; accent-color: var(--accent); cursor: pointer; }

        .install-btn {
            width: 100%; padding: 16px 20px; border-radius: 16px;
            border: 1px solid rgba(213,0,249,0.2);
            background: #110018;
            color: #CE93D8; font-size: .95rem; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: transform .15s, opacity .15s, border-color .2s;
            font-family: 'Sora', sans-serif;
        }
        .install-btn:hover { border-color: rgba(213,0,249,0.35); transform: translateY(-1px); }
        .install-btn:active { transform: scale(.96); opacity: .9; }

        .mct-footer {
            margin: 0 16px 6px; padding: 14px 16px; border-radius: 16px;
            background: linear-gradient(135deg, rgba(255,23,68,.06), rgba(0,180,216,.06));
            border: 1px solid rgba(255,23,68,.15);
            display: flex; align-items: center; gap: 12px;
        }
        .mct-badge {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 9px; padding: 5px 12px; font-family: var(--mono);
            font-size: .7rem; font-weight: 500; letter-spacing: 2px; color: white;
            text-transform: uppercase; white-space: nowrap;
            box-shadow: 0 2px 10px rgba(255,23,68,.25);
        }
        .mct-meta { font-size: .7rem; color: var(--sub); line-height: 1.5; }
        .mct-meta strong { color: var(--text); font-size: .75rem; display: block; }

        .legal-footer {
            text-align: center; padding: 12px 16px 20px;
            font-size: .72rem; color: var(--sub); line-height: 1.5;
        }

        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.96);
            display: none; align-items: center; justify-content: center;
            z-index: 3000; padding: 16px;
            backdrop-filter: blur(16px) saturate(180%);
        }
        .modal {
            background: var(--surface); width: 100%; max-width: 500px;
            border-radius: 26px; position: relative; max-height: 90vh;
            overflow-y: auto; padding: 24px; border: 1px solid var(--border2);
        }
        .modal::-webkit-scrollbar { width: 3px; }
        .modal::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
        .close-x {
            position: absolute; right: 18px; top: 12px; font-size: 28px;
            cursor: pointer; color: var(--sub); line-height: 1; z-index: 1;
        }
        .close-x:hover { color: var(--text); }
        .voice-btn {
            background: #001018;
            border: 1px solid rgba(0,180,216,.25);
            color: #4DD0E1; border-radius: 12px;
            padding: 12px 18px;
            font-weight: 700; margin-bottom: 15px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            gap: 8px; font-size: .85rem; transition: all .2s;
            font-family: 'Sora', sans-serif;
        }
        .important-note {
            background: rgba(255,23,68,.07); color: var(--text);
            padding: 18px; border-radius: 16px;
            border-left: 4px solid var(--accent);
            font-size: .92rem; line-height: 1.6; font-weight: 500; margin-top: 10px;
        }
        .guide-box { margin-bottom: 18px; }
        .guide-box b {
            display: block; margin-bottom: 10px; font-family: var(--mono);
            font-size: .72rem; color: var(--sub); text-transform: uppercase; letter-spacing: 1px;
        }
        .guide-box ul { list-style: none; padding-left: 0; }
        .guide-box li {
            margin-bottom: 10px; display: flex; align-items: flex-start;
            gap: 10px; font-size: .92rem; line-height: 1.5;
        }
        .cpr-anim {
            width: 90px; height: 90px; background: var(--accent-dim);
            border: 3px solid var(--accent); border-radius: 50%;
            margin: 18px auto; display: flex; align-items: center; justify-content: center;
            font-weight: 900; color: var(--accent); font-size: .75rem;
            animation: cprPulse .54s infinite;
        }
        @keyframes cprPulse { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: .7; } }

        .blood-option, .rh-option {
            background: var(--surface2); border: 1px solid var(--border);
            color: var(--text); font-weight: 700; font-size: 1.1rem;
            padding: 12px 0; border-radius: 12px; cursor: pointer; transition: all .2s;
        }
        .blood-option:hover, .rh-option:hover { border-color: var(--accent); background: var(--accent-dim); }
        .blood-option.selected, .rh-option.selected { background: var(--accent); border-color: var(--accent); color: white; }

        .sheet-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.9);
            display: none; align-items: flex-end; justify-content: center;
            z-index: 4000; backdrop-filter: blur(12px);
        }
        .sheet-overlay.on { display: flex; }
        .sheet {
            background: var(--surface); width: 100%; max-width: 540px;
            border-radius: 28px 28px 0 0; padding: 24px 20px 40px;
            border: 1px solid var(--border); border-bottom: none;
            box-shadow: 0 -8px 40px rgba(0,0,0,.6);
            max-height: 90vh; overflow-y: auto;
        }
        .sheet-handle {
            width: 40px; height: 4px; background: var(--border2);
            border-radius: 4px; margin: 0 auto 22px;
        }
        .sheet-close-btn {
            width: 100%; padding: 15px; border-radius: 15px;
            border: 1px solid rgba(255,23,68,0.2);
            background: #1a0407;
            color: #FF5370; font-weight: 800; font-size: .92rem; cursor: pointer;
            margin-top: 18px; transition: transform .15s, border-color .2s;
            font-family: 'Sora', sans-serif;
        }
        .sheet-close-btn:active { transform: scale(.96); }

        .ios-step {
            display: flex; align-items: flex-start; gap: 12px;
            margin-bottom: 12px; font-size: .9rem; line-height: 1.5;
        }
        .ios-step-num {
            min-width: 36px; height: 36px; border-radius: 50%;
            background: var(--accent); color: white; font-weight: 900;
            font-size: .85rem; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(255,23,68,.3);
        }

        .a11y-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .a11y-row:last-child { border-bottom: none; }
        .a11y-label { font-weight: 700; font-size: .9rem; }
        .a11y-desc { font-size: .72rem; color: var(--sub); margin-top: 2px; }

        .lang-btn {
            width: 100%; padding: 16px 18px; border-radius: 16px;
            border: 2px solid transparent; background: var(--surface2);
            color: var(--text); font-size: .95rem; font-weight: 800;
            cursor: pointer; display: flex; align-items: center; gap: 12px;
            transition: .2s; text-align: left;
            font-family: 'Sora', sans-serif;
        }

        #toast {
            position: fixed; bottom: calc(var(--nav-h) + 16px); left: 50%;
            transform: translateX(-50%) translateY(90px);
            opacity: 0;
            background: var(--surface2); color: var(--text);
            padding: 11px 22px; border-radius: 50px;
            font-size: .8rem; font-weight: 600; z-index: 9999;
            transition: transform .3s cubic-bezier(.34,1.56,.64,1), opacity .3s ease;
            white-space: nowrap; border: 1px solid var(--border2);
            box-shadow: 0 8px 32px rgba(0,0,0,.5); pointer-events: none;
            font-family: var(--mono);
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        @media (max-width: 400px) {
            .emergency-grid { grid-template-columns: 1fr 1fr; }
            .contacts-grid { grid-template-columns: 1fr 1fr; }
        }

        /* ===== YENİ: ONLİNE/OFFLİNE BANNER ===== */
        #offlineBanner {
            display: none; position: fixed; top: 0; left: 0; right: 0;
            z-index: 8999; background: #FF6D00; color: white;
            padding: 10px 16px; font-size: .78rem; font-weight: 700;
            text-align: center; font-family: var(--mono); letter-spacing: .5px;
            height: 40px; line-height: 1.2;
            display: none; align-items: center; justify-content: center;
        }
        #offlineBanner.visible {
            display: flex;
            animation: slideDown .3s ease-out;
        }
        body.light-mode #offlineBanner { background: #e65100; }

        /* ===== YENİ: HIZLI KOPYALA ===== */
        .copy-toast-inline {
            font-size: .62rem; color: var(--green); font-family: var(--mono);
            margin-left: 4px; opacity: 0; transition: opacity .3s;
        }
        .copy-toast-inline.show { opacity: 1; }

        /* ===== YENİ: ACİL ÖZETPİL ===== */
        .emergency-summary {
            margin: 14px 16px 0; padding: 14px 16px;
            background: linear-gradient(135deg, rgba(255,23,68,.06), rgba(0,180,216,.04));
            border: 1px solid rgba(255,23,68,.15); border-radius: 16px;
            display: grid;
            grid-template-columns: 1fr 1px 1fr 1px 1fr;
            gap: 0 10px; align-items: center;
        }
        body.light-mode .emergency-summary {
            background: linear-gradient(135deg, rgba(255,23,68,.04), rgba(0,180,216,.03));
        }
        .esm-item { text-align: center; padding: 2px 0; }
        .esm-num {
            font-family: var(--mono); font-weight: 900; font-size: 1.4rem;
            color: var(--accent); line-height: 1;
        }
        .esm-lbl { font-size: .58rem; color: var(--sub); letter-spacing: .8px; margin-top: 3px; text-transform: uppercase; font-family: var(--mono); }
        .esm-divider { width: 1px; background: var(--border2); height: 36px; justify-self: center; }

        /* ===== HAVA DURUMU STİLLERİ ===== */
        .weather-box {
            margin: 0 16px; padding: 16px;
            background: var(--surface); border-radius: 18px;
            border: 1px solid var(--border);
        }
        .weather-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
        }
        .weather-city {
            font-weight: 800; font-size: .88rem; color: var(--text);
            display: flex; align-items: center; gap: 6px;
        }
        .weather-city small {
            font-size: .65rem; color: var(--sub); font-family: var(--mono);
            font-weight: 400; letter-spacing: .5px;
        }
        .weather-row {
            display: flex; align-items: center; gap: 14px; margin-bottom: 10px;
        }
        .weather-icon { font-size: 2.8rem; line-height: 1; flex-shrink: 0; }
        .weather-info { flex: 1; }
        .weather-val {
            font-size: 1.7rem; font-weight: 900; color: var(--text);
            font-family: var(--mono); line-height: 1.1;
        }
        .weather-desc { font-size: .8rem; color: var(--sub); margin-top: 2px; }
        .weather-loc {
            font-size: .72rem; color: var(--sub); margin-top: 4px;
            font-family: var(--mono); letter-spacing: .3px;
        }
        .weather-alert {
            padding: 9px 13px; border-radius: 11px; font-size: .8rem;
            font-weight: 700; margin-bottom: 10px; border-left: 3px solid;
        }
        .weather-alert.hot   { background: rgba(255,109,0,.1); color: #FF8A50; border-color: var(--orange); }
        .weather-alert.cold  { background: rgba(0,180,216,.1); color: #4DD0E1; border-color: var(--blue); }
        .weather-alert.wind  { background: rgba(255,214,0,.08); color: #FFD740; border-color: var(--yellow); }
        .weather-alert.rain  { background: rgba(0,180,216,.08); color: #4DD0E1; border-color: var(--blue); }
        .weather-alert.ok    { background: rgba(0,230,118,.08); color: #69F0AE; border-color: var(--green); }
        body.light-mode .weather-alert.hot   { background: rgba(255,109,0,.07); color: #923500; }
        body.light-mode .weather-alert.cold  { background: rgba(0,180,216,.07); color: #004a6e; }
        body.light-mode .weather-alert.wind  { background: rgba(180,130,0,.07); color: #6b4400; }
        body.light-mode .weather-alert.rain  { background: rgba(0,130,200,.07); color: #004a6e; }
        body.light-mode .weather-alert.ok    { background: rgba(0,170,90,.07);  color: #005028; }
        .weather-details {
            display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px;
        }
        .weather-chip {
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 8px; padding: 5px 10px; font-size: .72rem;
            font-family: var(--mono); color: var(--text2); white-space: nowrap;
        }

        /* ===== DEĞİŞTİRİLMİŞ DEPREM SATIRI ===== */
        .q-row {
            display: flex; flex-direction: column;
            padding: 10px 0; border-bottom: 1px solid var(--border);
        }
        .q-row:last-child { border-bottom: none; }
        .q-row-top {
            display: flex; align-items: center; justify-content: space-between;
        }
        .q-loc {
            font-size: .8rem; color: var(--sub);
            margin-top: 3px; padding-left: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* ===== KOMPAKT ACİL ÇANTA ===== */
        .bag-section {
            margin: 0 16px 16px;
        }
        .bag-progress-bar {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px; background: var(--surface);
            border-radius: 14px; border: 1px solid var(--border); margin-bottom: 10px;
        }
        .bag-pct-num {
            font-family: var(--mono); font-size: 1.1rem; font-weight: 900;
            color: var(--accent); min-width: 42px; text-align: right;
        }
        .bag-bar { flex: 1; height: 6px; background: var(--surface3); border-radius: 99px; overflow: hidden; }
        .bag-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--orange)); border-radius: 99px; transition: width .3s; }
        .bag-count-lbl { font-family: var(--mono); font-size: .65rem; color: var(--sub); white-space: nowrap; }

        .bag-category { margin-bottom: 8px; }
        .bag-cat-label {
            font-family: var(--mono); font-size: .58rem; color: var(--sub);
            letter-spacing: 1.5px; text-transform: uppercase;
            padding: 0 2px 5px; display: block; font-weight: 500;
        }
        .bag-cat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
        }
        .bag-item {
            display: flex; align-items: center; gap: 8px;
            padding: 9px 10px; border-radius: 11px;
            background: var(--surface); border: 1px solid var(--border);
            cursor: pointer; transition: border-color .15s, background .15s;
            user-select: none;
        }
        .bag-item:active { transform: scale(.97); }
        .bag-item.checked {
            background: rgba(0,230,118,.07); border-color: rgba(0,230,118,.25);
        }
        .bag-check {
            width: 20px; height: 20px; border-radius: 6px; flex-shrink: 0;
            border: 1.5px solid var(--border2); background: var(--surface2);
            display: flex; align-items: center; justify-content: center;
            font-size: .75rem; font-weight: 900; color: var(--green);
            transition: background .15s, border-color .15s;
        }
        .bag-item.checked .bag-check {
            background: rgba(0,230,118,.15); border-color: var(--green);
        }
        .bag-icon { font-size: 1rem; flex-shrink: 0; line-height: 1; }
        .bag-label {
            font-size: .72rem; font-weight: 600; color: var(--text);
            line-height: 1.3; flex: 1;
        }
        .bag-item.checked .bag-label { color: var(--sub); text-decoration: line-through; }
        .bag-reset-btn {
            width: 100%; margin-top: 10px; padding: 11px;
            border-radius: 12px; border: 1px solid var(--border2);
            background: transparent; color: var(--sub); font-size: .78rem;
            font-weight: 700; cursor: pointer; transition: color .15s, border-color .15s;
            font-family: 'Sora', sans-serif;
        }
        .bag-reset-btn:hover { color: var(--accent); border-color: rgba(255,23,68,.3); }
        body.light-mode .bag-item { background: #fff; }
        body.light-mode .bag-item.checked { background: rgba(0,170,90,.06); border-color: rgba(0,170,90,.3); }
        .q-row-new {
            animation: qRowFadeIn .6s ease;
        }
        @keyframes qRowFadeIn {
            from { background: rgba(255,214,0,.15); }
            to   { background: transparent; }
        }
    </style>
</head>
<body>

<div class="ecg-decoration" aria-hidden="true">
    <div class="ecg-line"></div>
</div>

<svg style="position:absolute;width:0;height:0" aria-hidden="true" focusable="false">
  <defs>
    <filter id="colorblind-filter" color-interpolation-filters="linearRGB">
      <feColorMatrix type="matrix" values="0.625 0.375 0 0 0  0.7 0.3 0 0 0  0 0.3 0.7 0 0  0 0 0 1 0"/>
    </filter>
  </defs>
</svg>

<div id="breakingNews"></div>
<div id="offlineBanner">📡 Çevrimdışısınız — Acil rehber yine de kullanılabilir</div>

<header role="banner">
    <div class="header-brand">
        <div class="brand-icon" aria-hidden="true">
            <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="38" height="38" rx="10" fill="#1a0007"/>
                <rect width="38" height="38" rx="10" fill="url(#bg-grad)" opacity="0.6"/>
                <g class="logo-heart">
                    <path d="M19 30C19 30 6 21.5 6 13.5C6 10.4 8.5 8 11.5 8C13.7 8 15.6 9.3 16.7 11.1L19 14.5L21.3 11.1C22.4 9.3 24.3 8 26.5 8C29.5 8 32 10.4 32 13.5C32 21.5 19 30 19 30Z" fill="#FF1744" opacity="0.9"/>
                    <path class="logo-ecg" d="M8 20 L12 20 L14 16 L16 24 L17.5 18 L19 20 L21 20 L23 20 L25 16.5 L27 20 L30 20" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </g>
                <defs>
                    <linearGradient id="bg-grad" x1="0" y1="0" x2="38" y2="38">
                        <stop offset="0%" stop-color="#FF1744" stop-opacity="0.3"/>
                        <stop offset="100%" stop-color="#B71C1C" stop-opacity="0.1"/>
                    </linearGradient>
                </defs>
            </svg>
        </div>
        <div>
            <div class="brand-text">VITALIUM <span>PRO</span></div>
            <span class="brand-badge">ACİL DESTEK SİSTEMİ</span>
        </div>
    </div>
    <div class="header-actions">
        <button id="darkModeBtn" class="hdr-btn" onclick="toggleDarkMode()" aria-label="Tema değiştir">🌙</button>
        <button class="hdr-btn" onclick="openA11y()" aria-label="Erişilebilirlik" style="color:var(--blue);border-color:rgba(0,180,216,.2);">♿</button>
        <button id="langBtn" class="hdr-btn" onclick="openLangPanel()" aria-label="Dil seçimi" style="color:var(--green);border-color:rgba(0,230,118,.2);">🌐 TR</button>
        <div class="status-pill" aria-live="polite">
            <div class="status-dot" aria-hidden="true"></div>
            <span data-i18n="status">HAZIR</span>
        </div>
    </div>
</header>

<div class="app-content">

    <!-- TAB 1: ACİL -->
    <div class="tab-panel active" id="tab-acil">
        <div class="section-head">
            <span class="section-title-text">ACİL BUTONLAR</span>
            <div class="section-line"></div>
        </div>

        <!-- Acil Özet Kart -->
        <div class="emergency-summary" role="region" aria-label="Acil numaralar özeti">
            <div class="esm-item">
                <div class="esm-num">112</div>
                <div class="esm-lbl">AMBULANS</div>
            </div>
            <div class="esm-divider"></div>
            <div class="esm-item">
                <div class="esm-num">110</div>
                <div class="esm-lbl">İTFAİYE</div>
            </div>
            <div class="esm-divider"></div>
            <div class="esm-item">
                <div class="esm-num">155</div>
                <div class="esm-lbl">POLİS</div>
            </div>
        </div>

        <div class="emergency-grid">
            <button class="action-btn btn-sos" onclick="triggerSOS()" aria-label="SOS yardım çağrısı">
                <span class="btn-icon">🆘</span>
                <span class="btn-label">SOS</span>
            </button>
            <button class="action-btn btn-quick" onclick="openQuickEmergency()" aria-label="Hızlı acil rehber">
                <span class="btn-icon">⚡</span>
                <span class="btn-label" data-i18n="btn_quick">HIZLI</span>
            </button>
            <button class="action-btn btn-whistle" id="wBtn" onclick="toggleWhistle()" aria-label="Acil düdük">
                <span class="btn-icon">🔊</span>
                <span class="btn-label" id="wTxt" data-i18n="btn_whistle">DÜDÜK</span>
            </button>
            <button class="action-btn btn-blood" id="bgBtn" onclick="showBloodGroup()" aria-label="Kan grubu">
                <span class="btn-icon">🩸</span>
                <span class="btn-label" id="bgTxt" data-i18n="btn_blood">KAN GRUBU</span>
            </button>
        </div>

        <div class="section-head" style="padding-top:18px">
            <span class="section-title-text" data-i18n="sec_contacts">ACİL KONTAK</span>
            <div class="section-line"></div>
        </div>

        <div class="contacts-box">
            <div class="contacts-grid">
                <button class="contact-btn c-red" onclick="call('112')" data-i18n="contact_ambulance">🚑 Ambulans: 112 <span class="copy-toast-inline" id="cp112">✓</span></button>
                <button class="contact-btn c-orange" onclick="call('110')" data-i18n="contact_fire">🚒 İtfaiye: 110 <span class="copy-toast-inline" id="cp110">✓</span></button>
                <button class="contact-btn c-yellow" onclick="call('114')" data-i18n="contact_poison">☠️ Zehir: 114 <span class="copy-toast-inline" id="cp114">✓</span></button>
                <button class="contact-btn c-blue" onclick="call('155')" data-i18n="contact_police">🚔 Polis: 155 <span class="copy-toast-inline" id="cp155">✓</span></button>
                <button class="contact-btn c-green" onclick="call('122')">🏚️ AFAD: 122 <span class="copy-toast-inline" id="cp122">✓</span></button>
                <button class="contact-btn c-red" onclick="call('182')">🏥 Sağlık: 182 <span class="copy-toast-inline" id="cp182">✓</span></button>
            </div>
            <span class="custom-contacts-label" data-i18n="contact_saved">Kayıtlı Numaralar</span>
            <div id="customContacts" style="display:flex;flex-direction:column;gap:8px"></div>
            <button class="add-contact-btn" onclick="addContactField()" data-i18n="contact_add">+ Numara Ekle</button>
        </div>
    </div>

    <!-- TAB 2: SAĞLIK -->
    <div class="tab-panel" id="tab-saglik">
        <div class="section-head">
            <span class="section-title-text" data-i18n="sec_health">SAĞLIK ÖLÇÜMLERİ</span>
            <div class="section-line"></div>
        </div>

        <div class="health-duo">
            <div class="health-card" id="metroBox">
                <span class="health-card-title" data-i18n="cpr_title">⏱ Kalp Masajı</span>
                <div class="metro-ring" id="metroRing">
                    <span class="metro-bpm">110</span>
                    <span class="metro-lbl">BPM</span>
                </div>
                <div class="metro-counter" id="metroCount">0</div>
                <div class="metro-sub" id="metroSub" data-i18n="cpr_press">Başlat'a bas</div>
                <button class="metro-btn metro-start" id="metroStartBtn" onclick="metroStart()" data-i18n="cpr_start">▶ BAŞLAT</button>
                <button class="metro-btn metro-stop" id="metroStopBtn" onclick="metroStop()" data-i18n="cpr_stop">⏹ DURDUR</button>
                <button class="metro-reset-btn" onclick="metroReset()" data-i18n="cpr_reset">↺ SIFIRLA</button>
            </div>

            <div class="health-card" id="pulseBox">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <span class="health-card-title" data-i18n="pulse_title">💗 Nabız</span>
                    <button class="pulse-reset" onclick="pulseReset()" data-i18n="pulse_reset">Sıfırla</button>
                </div>
                <button class="pulse-tap-btn" id="pulseTapBtn" onclick="pulseTap()">
                    <div data-i18n="pulse_tap">👆 DOKUN</div>
                    <div style="font-size:.6rem;font-weight:600;opacity:.6;margin-top:2px" data-i18n="pulse_sub">Nabzı say</div>
                </button>
                <div class="pulse-stats-row">
                    <div class="pulse-stat">
                        <div class="pulse-stat-val" id="pulseBPM">—</div>
                        <div class="pulse-stat-lbl" data-i18n="pulse_bpm">ATM/DAK</div>
                    </div>
                    <div class="pulse-stat">
                        <div class="pulse-stat-val" id="pulseTaps">0</div>
                        <div class="pulse-stat-lbl" data-i18n="pulse_taps">DOKUN</div>
                    </div>
                </div>
                <div class="pulse-stat" style="text-align:center">
                    <div class="pulse-stat-val" id="pulseStatus" style="font-size:.95rem">—</div>
                    <div class="pulse-stat-lbl" data-i18n="pulse_status">DURUM</div>
                </div>
            </div>
        </div>

        <div class="section-head" style="padding-top:18px">
            <span class="section-title-text">İLK YARDIM TEMELLERİ</span>
            <div class="section-line"></div>
        </div>

        <div class="firstaid-box">
            <div class="fa-pill" style="background:rgba(255,23,68,.07);border-left:3px solid var(--accent)">
                <span class="fa-pill-icon">🆘</span>
                <div>
                    <div class="fa-pill-title" data-i18n="fa_emergency_title">ACİL DURUM</div>
                    <div class="fa-pill-desc" data-i18n="fa_emergency_desc">112'yi ara, yanında kal.</div>
                </div>
            </div>
            <div class="fa-pill" style="background:var(--blue-dim);border-left:3px solid var(--blue)">
                <span class="fa-pill-icon">✋</span>
                <div>
                    <div class="fa-pill-title" data-i18n="fa_bleed_title">KANAMA</div>
                    <div class="fa-pill-desc" data-i18n="fa_bleed_desc">Bezle 10 dk güçlü bas.</div>
                </div>
            </div>
            <div class="fa-pill" style="background:var(--green-dim);border-left:3px solid var(--green)">
                <span class="fa-pill-icon">🔥</span>
                <div>
                    <div class="fa-pill-title" data-i18n="fa_burn_title">YANIK</div>
                    <div class="fa-pill-desc" data-i18n="fa_burn_desc">Soğuk suyla 10–20 dk soğut.</div>
                </div>
            </div>
            <div class="fa-pill" style="background:rgba(255,214,0,.06);border-left:3px solid var(--yellow)">
                <span class="fa-pill-icon">😵</span>
                <div>
                    <div class="fa-pill-title" data-i18n="fa_unconscious_title">BİLİNÇSİZLİK</div>
                    <div class="fa-pill-desc" data-i18n="fa_unconscious_desc">Yan yatır, nefes kontrol et.</div>
                </div>
            </div>
            <div class="fa-pill" style="background:rgba(213,0,249,.06);border-left:3px solid var(--purple)">
                <span class="fa-pill-icon">🤕</span>
                <div>
                    <div class="fa-pill-title" data-i18n="fa_fracture_title">ÇIKIK/KIRIK</div>
                    <div class="fa-pill-desc" data-i18n="fa_fracture_desc">Hareket ettirme, sabitle.</div>
                </div>
            </div>
        </div>

        <div class="section-head" style="padding-top:18px">
            <span class="section-title-text">SAĞLIK NOKTALARI</span>
            <div class="section-line"></div>
        </div>

        <div class="hosp-box" id="hospitalBox" role="region" aria-label="Yakın hastane bulucu">
            <div style="font-size:.78rem;color:var(--sub);margin-bottom:10px;" data-i18n="hosp_desc">GPS ile en yakın sağlık noktasını bul.</div>
            <div class="hosp-type-grid" role="group">
                <button class="hosp-type-btn active" id="htHastane" onclick="setHospType('hastane')" aria-pressed="true">
                    <span>🏥</span><span data-i18n="hosp_hospital">Hastane</span>
                </button>
                <button class="hosp-type-btn" id="htAcil" onclick="setHospType('acil')" aria-pressed="false">
                    <span>🚨</span><span data-i18n="hosp_emergency">Acil Servis</span>
                </button>
                <button class="hosp-type-btn" id="htEczane" onclick="setHospType('eczane')" aria-pressed="false">
                    <span>💊</span><span data-i18n="hosp_pharmacy">Eczane</span>
                </button>
            </div>
            <button class="hosp-btn" id="hospFindBtn" onclick="findHospitals()">
                <span>📍</span> <span data-i18n="hosp_find">Yakını Bul</span>
            </button>
            <div id="hospResult" role="list" aria-live="polite" style="display:flex;flex-direction:column;gap:8px;margin-top:10px;"></div>
        </div>

        <div class="section-head" style="padding-top:18px">
            <span class="section-title-text" data-i18n="med_title">KİŞİSEL TIBBİ BİLGİLER</span>
            <div class="section-line"></div>
        </div>
        <div id="medicalBox" role="region" aria-label="Kişisel tıbbi bilgiler">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <strong style="font-size:.82rem;color:var(--blue);font-family:var(--mono);font-weight:500;">⚕️ TIBBİ NOTLAR</strong>
                <span style="font-size:.62rem;color:var(--sub);font-family:var(--mono)" data-i18n="med_auto">OTOMATİK KAYDEDİLİR</span>
            </div>
            <textarea id="medNotes" data-i18n-placeholder="med_placeholder"
                      placeholder="İlaçlar, kronik hastalıklar, alerjiler, kan grubu…"
                      oninput="saveMedical()" aria-label="Tıbbi notlar" rows="4"></textarea>
        </div>
    </div>

    <!-- TAB 3: REHBER -->
    <div class="tab-panel" id="tab-rehber">
        <div class="section-head">
            <span class="section-title-text" data-i18n="sec_guide">ACİL REHBER</span>
            <div class="section-line"></div>
        </div>
        <div class="search-wrap">
            <span class="search-icon-inner">🔍</span>
            <input id="searchInput" type="search" data-i18n-placeholder="search_placeholder"
                   placeholder="Kart ara… (deprem, yanık, kalp…)"
                   oninput="filterCards()" autocomplete="off">
        </div>
        <main id="appGrid" role="main"></main>
        <div id="noResult" data-i18n="no_result">Arama sonucu bulunamadı 🔍</div>
    </div>

    <!-- TAB 4: DEPREM -->
    <div class="tab-panel" id="tab-deprem">

        <div class="section-head">
            <span class="section-title-text" data-i18n="quake_title">SON DEPREMLER</span>
            <div class="section-line"></div>
            <div style="display:flex;align-items:center;gap:8px;margin-left:8px">
                <span id="qSrc" style="color:var(--accent);font-family:var(--mono);font-size:.6rem;font-weight:500;letter-spacing:.5px" data-i18n="quake_live">CANLI</span>
                <button onclick="getQuakes()" style="background:var(--surface2);border:1px solid var(--border);color:var(--sub);border-radius:8px;padding:4px 10px;font-size:.65rem;cursor:pointer;font-family:var(--mono);letter-spacing:.5px" title="Yenile">↺ YENİLE</button>
            </div>
        </div>

        <!-- Büyüklük Skalası -->
        <div class="quake-scale-bar">
            <div class="quake-scale-item"><span class="qsc qsc-low">M1–3</span><span class="qsc-lbl">Hafif</span></div>
            <div class="quake-scale-item"><span class="qsc qsc-mid">M3–5</span><span class="qsc-lbl">Orta</span></div>
            <div class="quake-scale-item"><span class="qsc qsc-high">M5–7</span><span class="qsc-lbl">Güçlü</span></div>
            <div class="quake-scale-item"><span class="qsc qsc-severe">M7+</span><span class="qsc-lbl">Yıkıcı</span></div>
        </div>

        <div id="quakeBox">
            <div id="quakeList" data-i18n="quake_loading">Sismik veriler yükleniyor…</div>
        </div>

        <!-- Deprem Anında Hızlı Rehber -->
        <div class="section-head" style="padding-top:18px">
            <span class="section-title-text">DEPREM ANINDA NE YAPMALIYIM?</span>
            <div class="section-line"></div>
        </div>
        <div class="quake-guide-cards">
            <div class="quake-guide-card" style="border-left-color:var(--green)">
                <div class="qgc-step" style="background:var(--green);color:#000">1</div>
                <div>
                    <div class="qgc-title">ÇÖK · KAPIN · TUTUN</div>
                    <div class="qgc-desc">Dizlerine çök, başını örtün, sabit eşyaya tutun</div>
                </div>
            </div>
            <div class="quake-guide-card" style="border-left-color:var(--yellow)">
                <div class="qgc-step" style="background:var(--yellow);color:#000">2</div>
                <div>
                    <div class="qgc-title">YERİNDE KAL</div>
                    <div class="qgc-desc">Merdiven veya kapıya koşma — sarsıntı bitene dek bekle</div>
                </div>
            </div>
            <div class="quake-guide-card" style="border-left-color:var(--orange)">
                <div class="qgc-step" style="background:var(--orange);color:#fff">3</div>
                <div>
                    <div class="qgc-title">TAHLİYE ET</div>
                    <div class="qgc-desc">Asansöre binme, gaz kokusuna dikkat, açık alana çık</div>
                </div>
            </div>
            <div class="quake-guide-card" style="border-left-color:var(--accent)">
                <div class="qgc-step" style="background:var(--accent);color:#fff">4</div>
                <div>
                    <div class="qgc-title">ARTÇILARA HAZIR OL</div>
                    <div class="qgc-desc">Yapıya geri girme — 112'yi meşgul etme, SMS gönder</div>
                </div>
            </div>
        </div>

        <!-- HAVA DURUMU -->
        <div class="section-head" style="padding-top:18px">
            <span class="section-title-text">HAVA DURUMU & UYARI</span>
            <div class="section-line"></div>
            <button onclick="fetchWeather()" style="margin-left:8px;background:var(--surface2);border:1px solid var(--border);color:var(--sub);border-radius:8px;padding:4px 10px;font-size:.65rem;cursor:pointer;font-family:var(--mono);letter-spacing:.5px" title="Yenile">↺</button>
        </div>
        <div class="weather-box" id="weatherBox">
            <div id="weatherContent" style="font-size:.8rem;color:var(--sub);display:flex;align-items:center;gap:8px">
                <span style="font-size:1.2rem">📍</span>
                <span>Konum alınıyor…</span>
            </div>
        </div>

        <!-- ACİL DURUM ÇANTASI -->
        <div class="section-head" style="padding-top:18px">
            <span class="section-title-text">72 SAATLİK ACİL ÇANTA</span>
            <div class="section-line"></div>
        </div>
        <div class="bag-section">
            <div class="bag-progress-bar">
                <div class="bag-bar"><div class="bag-bar-fill" id="bagBarFill" style="width:0%"></div></div>
                <span class="bag-pct-num" id="bagPct">%0</span>
                <span class="bag-count-lbl" id="bagCount">0/20</span>
            </div>
            <div id="bagGrid"></div>
            <button class="bag-reset-btn" onclick="bagReset()">↺ Listeyi Sıfırla</button>
        </div>

    </div>

    <!-- TAB 5: PROFİL -->
    <div class="tab-panel" id="tab-profil">
        <div class="section-head">
            <span class="section-title-text">AYARLAR & PROFİL</span>
            <div class="section-line"></div>
        </div>

        <div style="margin:0 16px 14px">
            <div id="installBar">
                <button class="install-btn" onclick="installApp()">
                    <span style="font-size:1.4rem">⬇️</span>
                    <div style="text-align:left;flex:1">
                        <div style="font-weight:900" data-i18n="install_title">Ana Ekrana Yükle</div>
                        <div style="font-size:.72rem;opacity:.8" data-i18n="install_sub">Saniyeler içinde açın</div>
                    </div>
                    <span>→</span>
                </button>
            </div>
        </div>

        <div class="profile-section" style="margin-bottom:14px">
            <div class="profile-row" onclick="toggleDarkMode()" style="cursor:pointer">
                <div class="profile-row-left">
                    <div class="profile-row-icon" style="background:rgba(255,214,0,.1)">🌙</div>
                    <div>
                        <div class="p-label">Tema</div>
                        <div class="p-desc">Açık / Koyu</div>
                    </div>
                </div>
                <button id="darkModeBtn2" class="profile-action-btn">Koyu</button>
            </div>
            <div class="profile-row" onclick="openA11y()" style="cursor:pointer">
                <div class="profile-row-left">
                    <div class="profile-row-icon" style="background:var(--blue-dim)">♿</div>
                    <div>
                        <div class="p-label">Erişilebilirlik</div>
                        <div class="p-desc">Kontrast, yazı boyutu, animasyon</div>
                    </div>
                </div>
                <span class="chevron">›</span>
            </div>
            <div class="profile-row" onclick="openLangPanel()" style="cursor:pointer">
                <div class="profile-row-left">
                    <div class="profile-row-icon" style="background:var(--green-dim)">🌐</div>
                    <div>
                        <div class="p-label">Dil</div>
                        <div class="p-desc">Türkçe / English</div>
                    </div>
                </div>
                <span class="chevron">›</span>
            </div>
        </div>

        <div class="mct-footer">
            <div class="mct-badge">MCT</div>
            <div class="mct-meta">
                <strong>MCT YAZILIM</strong>
                <span data-i18n="mct_sub">Acil Durum Teknolojileri</span>
            </div>
        </div>
        <div class="legal-footer" data-i18n-html="legal_text">
            ⚠️ <b>ÖNEMLİ:</b> Bu uygulama acil durumlarda hızlı referans sağlar. Profesyonel tıbbi eğitimin veya 112 servisinin yerini tutmaz.
        </div>
    </div>

</div>

<nav class="nav-bar" role="navigation" aria-label="Ana navigasyon">
    <div class="nav-items">
        <button class="nav-item active" id="nav-acil" onclick="switchTab('acil')" aria-label="Acil">
            <div class="nav-active-dot"></div>
            <span class="nav-icon">🆘</span>
            <span class="nav-label">ACİL</span>
        </button>
        <button class="nav-item" id="nav-saglik" onclick="switchTab('saglik')" aria-label="Sağlık">
            <div class="nav-active-dot"></div>
            <span class="nav-icon">💗</span>
            <span class="nav-label">SAĞLIK</span>
        </button>
        <button class="nav-item" id="nav-rehber" onclick="switchTab('rehber')" aria-label="Rehber">
            <div class="nav-active-dot"></div>
            <span class="nav-icon">🩺</span>
            <span class="nav-label">REHBER</span>
        </button>
        <button class="nav-item" id="nav-deprem" onclick="switchTab('deprem')" aria-label="Deprem">
            <div class="nav-active-dot"></div>
            <span class="nav-icon">🌍</span>
            <span class="nav-label">DEPREM</span>
        </button>
        <button class="nav-item" id="nav-profil" onclick="switchTab('profil')" aria-label="Profil">
            <div class="nav-active-dot"></div>
            <span class="nav-icon">⚙️</span>
            <span class="nav-label">AYARLAR</span>
        </button>
    </div>
</nav>

<!-- Main Modal -->
<div class="overlay" id="mainOverlay">
    <div class="modal" id="modalBox">
        <span class="close-x" onclick="closeModal()">×</span>
        <div id="modalBody"></div>
    </div>
</div>

<!-- Blood Group Modal -->
<div class="overlay" id="bloodGroupOverlay">
    <div class="modal" style="max-width:360px">
        <span class="close-x" onclick="closeBloodGroupModal()">×</span>
        <h2 style="color:var(--accent);margin-bottom:20px;font-weight:900">🩸 Kan Grubu</h2>
        <div style="margin-bottom:18px">
            <label style="display:block;margin-bottom:8px;font-family:var(--mono);font-size:.65rem;color:var(--sub);letter-spacing:1.5px;text-transform:uppercase">KAN GRUBU</label>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
                <button class="blood-option" data-group="A">A</button>
                <button class="blood-option" data-group="B">B</button>
                <button class="blood-option" data-group="AB">AB</button>
                <button class="blood-option" data-group="0">0</button>
            </div>
        </div>
        <div style="margin-bottom:22px">
            <label style="display:block;margin-bottom:8px;font-family:var(--mono);font-size:.65rem;color:var(--sub);letter-spacing:1.5px;text-transform:uppercase">RH FAKTÖRÜ</label>
            <div style="display:flex;gap:10px">
                <button class="rh-option" style="flex:1" data-rh="+">Rh +</button>
                <button class="rh-option" style="flex:1" data-rh="-">Rh −</button>
            </div>
        </div>
        <button id="saveBloodGroupBtn" class="voice-btn" style="width:100%;justify-content:center;background:#130018;border:1px solid rgba(213,0,249,.25);color:#CE93D8;margin-bottom:0">KAYDET</button>
    </div>
</div>

<!-- Quick Emergency Modal -->
<div class="overlay" id="quickEmergencyOverlay">
    <div class="modal" style="max-width:480px;max-height:85vh">
        <span class="close-x" onclick="closeQuickEmergency()">×</span>
        <h2 style="color:var(--accent);margin-bottom:10px;font-weight:900;font-size:1.2rem" data-i18n="quick_title">⚡ HIZLI ACİL REHBER</h2>
        <p style="color:var(--sub);font-size:.82rem;margin-bottom:14px" data-i18n="quick_sub">En yaygın acil durumlar</p>
        <div id="quickEmergencyGrid" style="display:grid;grid-template-columns:1fr;gap:9px"></div>
    </div>
</div>

<!-- A11y Panel -->
<div id="a11yPanel" class="sheet-overlay" role="dialog" aria-modal="true" aria-label="Erişilebilirlik ayarları">
  <div class="sheet">
    <div class="sheet-handle" aria-hidden="true"></div>
    <h2 style="font-weight:800;font-size:1.15rem;margin-bottom:5px">♿ Erişilebilirlik</h2>
    <p style="font-size:.78rem;color:var(--sub);margin-bottom:18px">Uygulamayı ihtiyacınıza göre özelleştirin</p>

    <div class="a11y-row">
      <div><div class="a11y-label">🔆 Yüksek Kontrast</div><div class="a11y-desc">Görme güçlüğü için renk kontrastını artırır</div></div>
      <label class="toggle-sw" aria-label="Yüksek kontrast modu">
        <input type="checkbox" id="togHighContrast" onchange="applyA11y()">
        <span class="toggle-track"></span>
      </label>
    </div>
    <div class="a11y-row">
      <div><div class="a11y-label">🎨 Renk Körü Modu</div><div class="a11y-desc">Yeşil-kırmızı renk körlüğü için filtre</div></div>
      <label class="toggle-sw" aria-label="Renk körü modu">
        <input type="checkbox" id="togColorblind" onchange="applyA11y()">
        <span class="toggle-track"></span>
      </label>
    </div>
    <div class="a11y-row">
      <div><div class="a11y-label">✋ Animasyonları Kapat</div><div class="a11y-desc">Epilepsi ve hareket duyarlılığı için</div></div>
      <label class="toggle-sw" aria-label="Animasyonları kapat">
        <input type="checkbox" id="togReduceMotion" onchange="applyA11y()">
        <span class="toggle-track"></span>
      </label>
    </div>
    <div class="a11y-row">
      <div><div class="a11y-label">👆 Büyük Dokunma Alanı</div><div class="a11y-desc">Motor güçlük için buton boyutlarını büyütür</div></div>
      <label class="toggle-sw" aria-label="Büyük dokunma alanı">
        <input type="checkbox" id="togBigTouch" onchange="applyA11y()">
        <span class="toggle-track"></span>
      </label>
    </div>
    <div class="a11y-row" style="flex-direction:column;align-items:flex-start;gap:10px">
      <div><div class="a11y-label">🔤 Yazı Boyutu</div><div class="a11y-desc">Tüm metni büyütür veya küçültür</div></div>
      <div style="width:100%;display:flex;align-items:center;gap:12px">
        <span style="font-size:.8rem;color:var(--sub)">A</span>
        <input type="range" class="font-slider" id="fontSizeSlider" min="0.85" max="1.5" step="0.05" value="1" oninput="applyFontSize(this.value)">
        <span style="font-size:1.2rem;font-weight:900;color:var(--sub)">A</span>
        <span id="fontSizeLabel" style="font-family:var(--mono);font-size:.75rem;color:var(--accent);min-width:36px">%100</span>
      </div>
    </div>
    <div class="a11y-row">
      <div><div class="a11y-label">🔊 Otomatik Sesli Okuma</div><div class="a11y-desc">Kart açıldığında otomatik okur</div></div>
      <label class="toggle-sw" aria-label="Otomatik sesli okuma">
        <input type="checkbox" id="togAutoSpeak" onchange="applyA11y()">
        <span class="toggle-track"></span>
      </label>
    </div>
    <div class="a11y-row">
      <div><div class="a11y-label">🎯 Belirgin Odak Halkası</div><div class="a11y-desc">Klavye erişimi için odak göstergesini büyütür</div></div>
      <label class="toggle-sw" aria-label="Belirgin odak halkası">
        <input type="checkbox" id="togFocusRing" onchange="applyA11y()">
        <span class="toggle-track"></span>
      </label>
    </div>
    <button class="sheet-close-btn" onclick="closeA11y()" data-i18n="a11y_save">Tamam, Kaydet</button>
  </div>
</div>

<!-- Language Panel -->
<div id="langPanel" class="sheet-overlay" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheet-handle" aria-hidden="true"></div>
    <h2 style="font-weight:800;font-size:1.15rem;margin-bottom:5px" data-i18n="lang_title">🌐 Dil Seçimi</h2>
    <p style="font-size:.78rem;color:var(--sub);margin-bottom:22px" data-i18n="lang_desc">Uygulamanın dilini seçin</p>
    <div style="display:flex;flex-direction:column;gap:10px">
      <button id="langTR" class="lang-btn" onclick="setLang('tr')">
        <span style="font-size:1.7rem">🇹🇷</span>
        <div><div style="font-weight:900">Türkçe</div><div style="font-size:.75rem;color:var(--sub)">Türkçe — Varsayılan</div></div>
        <span id="checkTR" style="margin-left:auto;color:var(--green);font-size:1.2rem">✓</span>
      </button>
      <button id="langEN" class="lang-btn" onclick="setLang('en')">
        <span style="font-size:1.7rem">🇬🇧</span>
        <div><div style="font-weight:900">English</div><div style="font-size:.75rem;color:var(--sub)">English — British/American</div></div>
        <span id="checkEN" style="margin-left:auto;color:var(--green);font-size:1.2rem;visibility:hidden">✓</span>
      </button>
    </div>
    <button onclick="closeLangPanel()" class="sheet-close-btn" data-i18n="lang_close">Kapat</button>
  </div>
</div>

<!-- iOS Guide -->
<div id="iosGuide" class="sheet-overlay">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <h3 style="font-weight:800;font-size:1.1rem;margin-bottom:18px">📱 iPhone'a Ekle</h3>
        <div class="ios-step" style="background:rgba(255,23,68,.06);padding:12px;border-radius:11px;margin-bottom:10px">
            <div class="ios-step-num" style="background:#00B4D8">1</div>
            <div><b>Safari'yi Açın</b> ve VITALIUM PRO'yu ziyaret edin</div>
        </div>
        <div class="ios-step" style="background:rgba(0,180,216,.06);padding:12px;border-radius:11px;margin-bottom:10px">
            <div class="ios-step-num" style="background:#00E676;color:#000">2</div>
            <div>Ekranın alt ortasındaki <b>⎋ Paylaş butonuna</b> dokun</div>
        </div>
        <div class="ios-step" style="background:rgba(0,230,118,.06);padding:12px;border-radius:11px;margin-bottom:10px">
            <div class="ios-step-num" style="background:#FFD600;color:#000">3</div>
            <div>Aşağı kaydırarak <b>"Ana Ekrana Ekle"</b>'yi bul</div>
        </div>
        <div class="ios-step" style="background:rgba(255,214,0,.06);padding:12px;border-radius:11px">
            <div class="ios-step-num">4</div>
            <div>Sağ üstteki <b style="color:var(--accent)">Ekle</b> butonuna dokun</div>
        </div>
        <button class="sheet-close-btn" onclick="document.getElementById('iosGuide').classList.remove('on')">Anladım</button>
    </div>
</div>

<!-- Android Guide -->
<div id="androidGuide" class="sheet-overlay">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <h3 style="font-weight:800;font-size:1.1rem;margin-bottom:18px">📱 Android'e Ekle</h3>
        <div class="ios-step" style="background:rgba(255,23,68,.06);padding:12px;border-radius:11px;margin-bottom:10px">
            <div class="ios-step-num" style="background:#00B4D8">1</div>
            <div><b>Chrome</b> ile VITALIUM PRO'ya gidin</div>
        </div>
        <div class="ios-step" style="background:rgba(0,180,216,.06);padding:12px;border-radius:11px;margin-bottom:10px">
            <div class="ios-step-num" style="background:#00E676;color:#000">2</div>
            <div>Sağ üst <b>⋮ (üç nokta)</b> menüsüne dokunun</div>
        </div>
        <div class="ios-step" style="background:rgba(0,230,118,.06);padding:12px;border-radius:11px">
            <div class="ios-step-num" style="background:#FFD600;color:#000">3</div>
            <div><b>"Ana ekrana ekle"</b> veya <b>"Uygulamayı yükle"</b></div>
        </div>
        <button class="sheet-close-btn" onclick="document.getElementById('androidGuide').classList.remove('on')">Anladım</button>
    </div>
</div>

<!-- Desktop Guide -->
<div id="desktopGuide" class="sheet-overlay">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <h3 style="font-weight:800;font-size:1.1rem;margin-bottom:18px">🖥️ Bilgisayara Yükle</h3>
        <div class="ios-step" style="background:rgba(0,180,216,.06);padding:12px;border-radius:11px;margin-bottom:10px">
            <div class="ios-step-num" style="background:#00B4D8">C</div>
            <div><b>Chrome / Edge:</b> Adres çubuğundaki <b>⊕ Yükle</b> simgesine tıkla</div>
        </div>
        <div class="ios-step" style="background:rgba(255,109,0,.06);padding:12px;border-radius:11px">
            <div class="ios-step-num" style="background:#FF6D00">F</div>
            <div><b>Firefox:</b> Hamburger Menü > Uygulamalar > Bu sayfayı yükle</div>
        </div>
        <button class="sheet-close-btn" onclick="document.getElementById('desktopGuide').classList.remove('on')">Anladım</button>
    </div>
</div>

<div id="toast" role="status" aria-live="assertive" aria-atomic="true"></div>

<script>
'use strict';

/* ===== TAB NAVIGATION ===== */
var currentTab = 'acil';
function switchTab(name) {
    document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
    document.querySelectorAll('.nav-item').forEach(function(b) { b.classList.remove('active'); });
    document.getElementById('tab-' + name).classList.add('active');
    document.getElementById('nav-' + name).classList.add('active');
    currentTab = name;
    if (name === 'rehber' && document.getElementById('appGrid').children.length === 0) {
        render();
    }
}

function syncThemeBtn() {
    var btn2 = document.getElementById('darkModeBtn2');
    if (btn2) btn2.textContent = isDark ? 'Koyu ✓' : 'Açık ✓';
    var btn1 = document.getElementById('darkModeBtn');
    if (btn1) btn1.textContent = isDark ? '🌙' : '☀️';
}

/* ===== DARK MODE ===== */
var isDark = true;
function toggleDarkMode() {
    isDark = !isDark;
    document.body.classList.toggle('light-mode', !isDark);
    document.getElementById('darkModeBtn').textContent = isDark ? '🌙' : '☀️';
    document.getElementById('darkModeBtn').setAttribute('aria-label', isDark ? 'Açık temaya geç' : 'Koyu temaya geç');
    try { localStorage.setItem('vitalium_theme', isDark ? 'dark' : 'light'); } catch(e){}
    syncThemeBtn();
}
(function() {
    try {
        var saved = localStorage.getItem('vitalium_theme');
        if (saved === 'light') { isDark = false; document.body.classList.add('light-mode'); document.getElementById('darkModeBtn').textContent = '☀️'; }
    } catch(e){}
})();

/* ===== DİL / LANGUAGE (i18n) ===== */
var currentLang = 'tr';
var TRANSLATIONS = {
    tr: {
        status: 'HAZIR',
        btn_quick: 'HIZLI', btn_whistle: 'DÜDÜK', btn_blood: 'KAN GRUBU',
        med_title: '⚕️ KİŞİSEL TIBBİ BİLGİLER', med_auto: 'OTOMATİK KAYDEDİLİR',
        med_placeholder: 'İlaçlar, kronik hastalıklar, alerjiler, kan grubu…',
        quake_title: '📍 SON DEPREMLER', quake_live: 'CANLI', quake_loading: 'Sismik veriler yükleniyor…',
        sec_health: '💗 SAĞLIK ÖLÇÜMLERİ',
        sec_contacts: '🆘 ACİL KONTAK NUMARALAR',
        sec_guide: '🩺 ACİL REHBER',
        sec_firstaid_hosp: '📋 İLK YARDIM & 🏥 SAĞLIK NOKTALARI',
        cpr_title: '⏱ Kalp Masajı', cpr_press: "Başlat'a bas",
        cpr_start: '▶ BAŞLAT', cpr_stop: '⏹ DURDUR', cpr_reset: '↺ SIFIRLA',
        pulse_title: '💗 Nabız Ölçümü', pulse_reset: 'Sıfırla',
        pulse_tap: '👆 DOKUN', pulse_sub: 'Nabzı say',
        pulse_bpm: 'ATIM/DAK', pulse_taps: 'DOKUNMA', pulse_status: 'DURUM',
        fa_emergency_title: '🆘 ACİL DURUM', fa_emergency_desc: '112\'yi ara, yanında kal.',
        fa_bleed_title: '✋ KANAMA',       fa_bleed_desc: 'Bezle 10 dk güçlü bas.',
        fa_burn_title: '🔥 YANIK',         fa_burn_desc: 'Soğuk suyla 10–20 dk soğut.',
        fa_unconscious_title: '😵 BİLİNÇSİZLİK', fa_unconscious_desc: 'Yan yatır, nefes kontrol et.',
        fa_fracture_title: '🤕 ÇIKIK/KIRIK', fa_fracture_desc: 'Hareket ettirme, sabitle.',
        hosp_desc: 'GPS ile en yakın sağlık noktasını bul.',
        hosp_hospital: 'Hastane', hosp_emergency: 'Acil Servis', hosp_pharmacy: 'Eczane',
        hosp_find: 'Yakını Bul',
        hosp_locating: '⏳ Konum alınıyor…',
        hosp_btn_map: '🗺️ Haritada Gör', hosp_btn_call: '📞 112 Ara', hosp_btn_182: '📞 182 Ara',
        hosp_map_label: 'Haritada Göster',
        hosp_gps_based: '📍 GPS konumunuza göre',
        hosp_ip_based:  '🌐 IP bazlı konum (yaklaşık)',
        hosp_112_name: '🚑 112 Acil', hosp_112_desc: 'Ambulans · Kurtarma · Sesli yönlendirme',
        hosp_182_name: 'ℹ️ ALO 182 Sağlık', hosp_182_desc: '7/24 ücretsiz sağlık danışma hattı',
        hosp_no_gps: 'Tarayıcınız konum özelliğini desteklemiyor.',
        hosp_denied: 'Konum alınamadı.',
        hosp_manual: '→ Manuel olarak haritada ara',
        contact_ambulance: '🚑 Ambulans: 112', contact_fire: '🚒 İtfaiye: 110',
        contact_poison: '☠️ Zehir: 114',       contact_police: '🚔 Polis: 155',
        contact_saved: 'CİHAZDA KAYDEDİLMİŞ - HIZLI ARAMA',
        contact_add: '+ Numara Ekle',
        search_placeholder: 'Kart ara… (deprem, yanık, kalp…)',
        no_result: 'Arama sonucu bulunamadı 🔍',
        install_title: 'Ana Ekrana Yükle',
        install_sub: 'Saniyeler içinde açın — Her zaman erişilebilir',
        mct_sub: 'Acil Durum Teknolojileri',
        legal_text: '⚠️ <b>ÖNEMLİ BİLGİLENDİRME:</b> Bu uygulama acil durumlarda hızlı referans sağlamak amacıyla tasarlanmıştır. Profesyonel ilk yardım eğitiminin veya 112 Acil servisinin yerini tutmaz.',
        modal_listen: 'SESLİ DİNLE',
        modal_stop: '⏹ DURDUR',
        modal_do: '✓ YAPILACAKLAR', modal_dont: '✕ YAPILMAYACAKLAR',
        modal_cpr_press: 'BASTIR', modal_cpr_note: 'Daire büyüdükçe göğse baskı uygulayın',
        blood_title: '🩸 Kan Grubu', blood_label: 'KAN GRUBU', rh_label: 'RH FAKTÖRÜ', blood_save: 'KAYDET',
        quick_title: '⚡ HIZLI ACİL REHBER',
        quick_sub: 'En yaygın acil durumlar — dokunarak açın:',
        a11y_save: 'Tamam, Kaydet',
        a11y_title: '♿ Erişilebilirlik', a11y_desc: 'Uygulamayı ihtiyacınıza göre özelleştirin',
        a11y_contrast_lbl: '🔆 Yüksek Kontrast', a11y_contrast_desc: 'Görme güçlüğü için renk kontrastını artırır',
        a11y_colorblind_lbl: '🎨 Renk Körü Modu', a11y_colorblind_desc: 'Yeşil-kırmızı renk körlüğü (deuteranopia) için filtre',
        a11y_motion_lbl: '✋ Animasyonları Kapat', a11y_motion_desc: 'Epilepsi ve hareket duyarlılığı için tüm animasyonları durdurur',
        a11y_touch_lbl: '👆 Büyük Dokunma Alanı', a11y_touch_desc: 'Motor güçlük yaşayanlar için buton boyutlarını büyütür',
        a11y_font_lbl: '🔤 Yazı Boyutu', a11y_font_desc: 'Tüm metni büyütür veya küçültür',
        a11y_speak_lbl: '🔊 Otomatik Sesli Okuma', a11y_speak_desc: 'Kart açıldığında içeriği otomatik olarak sesli okur',
        a11y_focus_lbl: '🎯 Belirgin Odak Halkası', a11y_focus_desc: 'Klavye ve switch erişimi için odak göstergesini büyütür',
        lang_title: '🌐 Dil Seçimi', lang_desc: 'Uygulamanın dilini seçin', lang_close: 'Kapat',
        contact_input_ph: 'İsim ve numara…', contact_delete: '✕',
        sos_toast: '🆘 SOS SİNYALİ GÖNDERİLİYOR!',
        pulse_low: 'Düşük', pulse_normal: 'Normal', pulse_high: 'Yüksek',
        whistle_on: '🔊 Acil düdük çalıyor', whistle_off: '🔇 Düdük durduruldu',
        blood_saved_toast: 'Kan grubu kaydedildi',
    },
    en: {
        status: 'READY',
        btn_quick: 'QUICK', btn_whistle: 'WHISTLE', btn_blood: 'BLOOD TYPE',
        med_title: '⚕️ PERSONAL MEDICAL INFO', med_auto: 'AUTO-SAVED',
        med_placeholder: 'Medications, chronic conditions, allergies, blood type…',
        quake_title: '📍 RECENT EARTHQUAKES', quake_live: 'LIVE', quake_loading: 'Loading seismic data…',
        sec_health: '💗 HEALTH MEASUREMENTS',
        sec_contacts: '🆘 EMERGENCY CONTACTS',
        sec_guide: '🩺 EMERGENCY GUIDE',
        sec_firstaid_hosp: '📋 FIRST AID & 🏥 NEARBY HEALTH',
        cpr_title: '⏱ CPR Metronome', cpr_press: 'Press Start',
        cpr_start: '▶ START', cpr_stop: '⏹ STOP', cpr_reset: '↺ RESET',
        pulse_title: '💗 Pulse Meter', pulse_reset: 'Reset',
        pulse_tap: '👆 TAP', pulse_sub: 'Count your pulse',
        pulse_bpm: 'BPM', pulse_taps: 'TAPS', pulse_status: 'STATUS',
        fa_emergency_title: '🆘 EMERGENCY',       fa_emergency_desc: 'Call 112, stay with them.',
        fa_bleed_title: '✋ BLEEDING',             fa_bleed_desc: 'Press firmly with cloth 10 min.',
        fa_burn_title: '🔥 BURN',                 fa_burn_desc: 'Cool under water 10–20 min.',
        fa_unconscious_title: '😵 UNCONSCIOUS',   fa_unconscious_desc: 'Recovery position, check breathing.',
        fa_fracture_title: '🤕 FRACTURE/DISLOC.', fa_fracture_desc: "Don't move, immobilise.",
        hosp_desc: 'Find the nearest health point via GPS.',
        hosp_hospital: 'Hospital', hosp_emergency: 'Emergency', hosp_pharmacy: 'Pharmacy',
        hosp_find: 'Find Nearby',
        hosp_locating: '⏳ Getting location…',
        hosp_btn_map: '🗺️ View on Map', hosp_btn_call: '📞 Call 112', hosp_btn_182: '📞 Call 182',
        hosp_map_label: 'Show on Map',
        hosp_gps_based: '📍 Based on your GPS location',
        hosp_ip_based:  '🌐 Approximate location (IP-based)',
        hosp_112_name: '🚑 112 Emergency', hosp_112_desc: 'Ambulance · Rescue · Voice guidance',
        hosp_182_name: 'ℹ️ Health Line 182', hosp_182_desc: 'Free 24/7 health advisory',
        hosp_no_gps: 'Your browser does not support geolocation.',
        hosp_denied: 'Location unavailable.',
        hosp_manual: '→ Search manually on map',
        contact_ambulance: '🚑 Ambulance: 112', contact_fire: '🚒 Fire: 110',
        contact_poison: '☠️ Poison: 114',       contact_police: '🚔 Police: 155',
        contact_saved: 'SAVED ON DEVICE — QUICK DIAL',
        contact_add: '+ Add Number',
        search_placeholder: 'Search cards… (earthquake, burn, heart…)',
        no_result: 'No results found 🔍',
        install_title: 'Add to Home Screen',
        install_sub: 'Open in seconds — Always accessible',
        mct_sub: 'Emergency Technologies',
        legal_text: '⚠️ <b>IMPORTANT:</b> This app is designed to provide quick reference in emergencies. It does not replace professional first aid training or 112 Emergency services.',
        modal_listen: 'LISTEN ALOUD',
        modal_stop: '⏹ STOP',
        modal_do: '✓ DO', modal_dont: '✕ DON\'T',
        modal_cpr_press: 'PUSH', modal_cpr_note: 'As the circle grows, apply chest compression',
        blood_title: '🩸 Blood Type', blood_label: 'BLOOD TYPE', rh_label: 'RH FACTOR', blood_save: 'SAVE',
        quick_title: '⚡ QUICK EMERGENCY GUIDE',
        quick_sub: 'Most common emergencies — tap to open:',
        a11y_save: 'OK, Save',
        a11y_title: '♿ Accessibility', a11y_desc: 'Customise the app to your needs',
        a11y_contrast_lbl: '🔆 High Contrast', a11y_contrast_desc: 'Increases colour contrast for visual impairments',
        a11y_colorblind_lbl: '🎨 Colour Blind Mode', a11y_colorblind_desc: 'Filter for green-red colour blindness (deuteranopia)',
        a11y_motion_lbl: '✋ Reduce Motion', a11y_motion_desc: 'Stops all animations for epilepsy / motion sensitivity',
        a11y_touch_lbl: '👆 Large Touch Areas', a11y_touch_desc: 'Enlarges buttons for motor difficulties',
        a11y_font_lbl: '🔤 Font Size', a11y_font_desc: 'Enlarge or reduce all text',
        a11y_speak_lbl: '🔊 Auto Read Aloud', a11y_speak_desc: 'Reads card content automatically when opened',
        a11y_focus_lbl: '🎯 Prominent Focus Ring', a11y_focus_desc: 'Larger focus indicator for keyboard / switch access',
        lang_title: '🌐 Language', lang_desc: 'Select the app language', lang_close: 'Close',
        contact_input_ph: 'Name and number…', contact_delete: '✕',
        sos_toast: '🆘 SENDING SOS SIGNAL!',
        pulse_low: 'Low', pulse_normal: 'Normal', pulse_high: 'High',
        whistle_on: '🔊 Emergency whistle playing', whistle_off: '🔇 Whistle stopped',
        blood_saved_toast: 'Blood type saved',
    }
};

function t(key) {
    var lang = TRANSLATIONS[currentLang] || TRANSLATIONS['tr'];
    return lang[key] !== undefined ? lang[key] : (TRANSLATIONS['tr'][key] || key);
}

function applyTranslations() {
    var lang = currentLang;
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        var val = t(key);
        if (val !== undefined) el.textContent = val;
    });
    document.querySelectorAll('[data-i18n-html]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-html');
        var val = t(key);
        if (val !== undefined) el.innerHTML = val;
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-placeholder');
        var val = t(key);
        if (val !== undefined) el.placeholder = val;
    });
    applyA11yTranslations();
    updateHospTypeMapLang();
    var btn = document.getElementById('langBtn');
    if (btn) btn.innerHTML = '🌐 ' + (lang === 'tr' ? 'TR' : 'EN');
    var ck_tr = document.getElementById('checkTR');
    var ck_en = document.getElementById('checkEN');
    if (ck_tr) ck_tr.style.visibility = lang === 'tr' ? 'visible' : 'hidden';
    if (ck_en) ck_en.style.visibility = lang === 'en' ? 'visible' : 'hidden';
    var lTR = document.getElementById('langTR');
    var lEN = document.getElementById('langEN');
    if (lTR) lTR.style.borderColor = lang === 'tr' ? 'var(--green)' : 'transparent';
    if (lEN) lEN.style.borderColor = lang === 'en' ? 'var(--green)' : 'transparent';
}

function applyA11yTranslations() {
    var map = [
        ['togHighContrast',  'a11y_contrast_lbl',  'a11y_contrast_desc'],
        ['togColorblind',    'a11y_colorblind_lbl', 'a11y_colorblind_desc'],
        ['togReduceMotion',  'a11y_motion_lbl',     'a11y_motion_desc'],
        ['togBigTouch',      'a11y_touch_lbl',      'a11y_touch_desc'],
        ['togAutoSpeak',     'a11y_speak_lbl',       'a11y_speak_desc'],
        ['togFocusRing',     'a11y_focus_lbl',       'a11y_focus_desc'],
    ];
    map.forEach(function(row) {
        var inp = document.getElementById(row[0]);
        if (!inp) return;
        var row_el = inp.closest('.a11y-row');
        if (!row_el) return;
        var lbl = row_el.querySelector('.a11y-label');
        var desc = row_el.querySelector('.a11y-desc');
        if (lbl) lbl.textContent = t(row[1]);
        if (desc) desc.textContent = t(row[2]);
    });
    var fontRow = document.querySelector('#fontSizeSlider')?.closest('.a11y-row');
    if (fontRow) {
        var lbl = fontRow.querySelector('.a11y-label');
        var desc = fontRow.querySelector('.a11y-desc');
        if (lbl) lbl.textContent = t('a11y_font_lbl');
        if (desc) desc.textContent = t('a11y_font_desc');
    }
    var h2 = document.querySelector('#a11yPanel h2');
    var p = document.querySelector('#a11yPanel .sheet > p');
    if (h2) h2.textContent = t('a11y_title');
    if (p) p.textContent = t('a11y_desc');
}

function updateHospTypeMapLang() {
    hospTypeMap = {
        'hastane': { q: currentLang === 'en' ? 'hospital'       : 'hastane',    label: t('hosp_hospital'),  emoji:'🏥', qEn:'hospital' },
        'acil':    { q: currentLang === 'en' ? 'emergency room'  : 'acil servis', label: t('hosp_emergency'), emoji:'🚨', qEn:'emergency room' },
        'eczane':  { q: currentLang === 'en' ? 'pharmacy'        : 'eczane',      label: t('hosp_pharmacy'),  emoji:'💊', qEn:'pharmacy' }
    };
}

function openLangPanel() {
    document.getElementById('langPanel').classList.add('on');
}
function closeLangPanel() {
    document.getElementById('langPanel').classList.remove('on');
}
function setLang(lang) {
    currentLang = lang;
    try { localStorage.setItem('vitalium_lang', lang); } catch(e) {}
    applyTranslations();
    render();
    closeLangPanel();
    showToast(lang === 'en' ? '🇬🇧 Language: English' : '🇹🇷 Dil: Türkçe', 2000);
}
(function() {
    try {
        var saved = localStorage.getItem('vitalium_lang');
        if (saved === 'en') { currentLang = 'en'; }
    } catch(e) {}
})();

/* ===== ERİŞİLEBİLİRLİK (A11Y) ===== */
var a11yState = { highContrast:false, colorblind:false, reduceMotion:false, bigTouch:false, autoSpeak:false, focusRing:false, fontSize:1 };
function openA11y() {
    document.getElementById('a11yPanel').classList.add('on');
    document.getElementById('a11yPanel').focus();
}
function closeA11y() {
    document.getElementById('a11yPanel').classList.remove('on');
    saveA11y();
}
function applyA11y() {
    a11yState.highContrast  = document.getElementById('togHighContrast').checked;
    a11yState.colorblind    = document.getElementById('togColorblind').checked;
    a11yState.reduceMotion  = document.getElementById('togReduceMotion').checked;
    a11yState.bigTouch      = document.getElementById('togBigTouch').checked;
    a11yState.autoSpeak     = document.getElementById('togAutoSpeak').checked;
    a11yState.focusRing     = document.getElementById('togFocusRing').checked;
    var b = document.body;
    b.classList.toggle('high-contrast',   a11yState.highContrast);
    b.classList.toggle('colorblind-mode', a11yState.colorblind);
    b.classList.toggle('reduce-motion',   a11yState.reduceMotion);
    b.classList.toggle('big-touch',       a11yState.bigTouch);
    if (a11yState.focusRing) {
        var s = document.getElementById('focusRingStyle');
        if (!s) { s = document.createElement('style'); s.id = 'focusRingStyle'; document.head.appendChild(s); }
        s.textContent = '*:focus{outline:4px solid #e11d48 !important;outline-offset:3px !important;}';
    } else {
        var s2 = document.getElementById('focusRingStyle');
        if (s2) s2.textContent = '';
    }
}
function applyFontSize(val) {
    a11yState.fontSize = parseFloat(val);
    document.documentElement.style.setProperty('--font-scale', val);
    document.getElementById('fontSizeLabel').textContent = Math.round(val * 100) + '%';
}
function saveA11y() {
    try { localStorage.setItem('vitalium_a11y', JSON.stringify(a11yState)); } catch(e){}
}
function loadA11y() {
    try {
        var saved = localStorage.getItem('vitalium_a11y');
        if (!saved) return;
        var s = JSON.parse(saved);
        a11yState = Object.assign(a11yState, s);
        document.getElementById('togHighContrast').checked  = !!s.highContrast;
        document.getElementById('togColorblind').checked    = !!s.colorblind;
        document.getElementById('togReduceMotion').checked  = !!s.reduceMotion;
        document.getElementById('togBigTouch').checked      = !!s.bigTouch;
        document.getElementById('togAutoSpeak').checked     = !!s.autoSpeak;
        document.getElementById('togFocusRing').checked     = !!s.focusRing;
        if (s.fontSize && s.fontSize !== 1) {
            document.getElementById('fontSizeSlider').value = s.fontSize;
            applyFontSize(s.fontSize);
        }
        applyA11y();
    } catch(e){}
}
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var panel = document.getElementById('a11yPanel');
        if (panel.classList.contains('on')) closeA11y();
    }
});

/* ===== HASTANE & ECZANE BULUCU ===== */
var hospType = 'hastane';
var hospTypeMap = {
    'hastane': { q:'hastane', label:'Hastane', emoji:'🏥', qEn:'hospital' },
    'acil':    { q:'acil servis', label:'Acil Servis', emoji:'🚨', qEn:'emergency room' },
    'eczane':  { q:'eczane', label:'Eczane', emoji:'💊', qEn:'pharmacy' }
};

function setHospType(type) {
    hospType = type;
    ['hastane','acil','eczane'].forEach(function(tp) {
        var el = document.getElementById('ht' + tp.charAt(0).toUpperCase() + tp.slice(1));
        if (el) {
            el.classList.toggle('active', tp === type);
            el.setAttribute('aria-pressed', tp === type ? 'true' : 'false');
        }
    });
    var result = document.getElementById('hospResult');
    if (result) result.innerHTML = '';
}

function hospSetLoading(on) {
    var btn = document.getElementById('hospFindBtn');
    if (!btn) return;
    btn.disabled = on;
    btn.innerHTML = on
        ? '<span>⏳</span> <span>' + t('hosp_locating') + '</span>'
        : '<span>📍</span> <span>' + t('hosp_find') + '</span>';
}

function hospCard(bg, border, icon, name, desc, btnText, btnBg, btnAction) {
    return '<div style="padding:12px 14px;border-radius:13px;background:' + bg + ';border:1px solid ' + border + ';display:flex;flex-direction:column;gap:9px;">' +
        '<div style="display:flex;align-items:center;gap:10px;">' +
        '<span style="font-size:1.5rem;line-height:1;flex-shrink:0">' + icon + '</span>' +
        '<div><div style="font-weight:800;font-size:.85rem;color:var(--text);margin-bottom:2px">' + name + '</div>' +
        '<div style="font-size:.7rem;color:var(--sub)">' + desc + '</div></div>' +
        '</div>' +
        '<button onclick="' + btnAction + '" style="width:100%;padding:10px;border-radius:9px;border:none;background:' + btnBg + ';color:#fff;font-weight:800;font-size:.82rem;cursor:pointer;letter-spacing:.3px;font-family:Sora,sans-serif">' +
        btnText + '</button></div>';
}

function findHospitals() {
    hospSetLoading(true);
    var result = document.getElementById('hospResult');
    if (result) result.innerHTML = '';

    getLocationWithFallback(
        function(loc) {
            hospSetLoading(false);
            var lat = parseFloat(loc.latitude);
            var lng = parseFloat(loc.longitude);
            if (isNaN(lat) || isNaN(lng)) {
                if (result) result.innerHTML = '<p style="color:var(--sub);font-size:.82rem;padding:8px 0">⚠️ ' + t('hosp_denied') + '</p>';
                return;
            }
            var info = hospTypeMap[hospType];
            var searchQ = currentLang === 'en' ? (info.qEn || info.q) : info.q;
            var mapsUrl = 'https://www.google.com/maps/search/' + encodeURIComponent(searchQ) + '/@' + lat.toFixed(5) + ',' + lng.toFixed(5) + ',15z';
            var locLabel = loc.city
                ? (loc.byIP ? '🌐 ' : '📍 ') + escHtml(loc.city)
                : (loc.byIP ? t('hosp_ip_based') : t('hosp_gps_based'));

            if (result) result.innerHTML =
                '<div style="display:flex;flex-direction:column;gap:8px;margin-top:4px">' +
                hospCard(
                    'var(--green-dim)', 'rgba(0,230,118,.22)',
                    info.emoji,
                    info.label + ' — ' + t('hosp_map_label'),
                    locLabel,
                    t('hosp_btn_map'), '#166534',
                    "window.open('" + mapsUrl + "','_blank')"
                ) +
                hospCard(
                    'rgba(255,23,68,.06)', 'rgba(255,23,68,.2)',
                    '🚑', t('hosp_112_name'), t('hosp_112_desc'),
                    t('hosp_btn_call'), '#991b1b',
                    "window.location='tel:112'"
                ) +
                hospCard(
                    'rgba(0,180,216,.06)', 'rgba(0,180,216,.2)',
                    'ℹ️', t('hosp_182_name'), t('hosp_182_desc'),
                    t('hosp_btn_182'), '#075985',
                    "window.location='tel:182'"
                ) +
                '</div>';

            if (loc.city) showToast('📍 ' + loc.city, 2000);
        },
        function() {
            hospSetLoading(false);
            var info = hospTypeMap[hospType];
            var searchQ = currentLang === 'en' ? (info.qEn || info.q) : info.q;
            if (result) result.innerHTML =
                '<div style="padding:12px 14px;border-radius:12px;background:rgba(255,109,0,.07);border:1px solid rgba(255,109,0,.2);font-size:.82rem">' +
                '<b style="color:var(--orange)">⚠️ ' + t('hosp_denied') + '</b>' +
                '<div style="display:flex;gap:8px;margin-top:10px">' +
                '<a href="https://www.google.com/maps/search/' + encodeURIComponent(searchQ) + '" target="_blank" rel="noopener" ' +
                'style="flex:1;text-align:center;padding:9px;background:var(--blue-dim);border:1px solid rgba(0,180,216,.25);border-radius:9px;color:var(--blue);font-weight:700;font-size:.8rem;text-decoration:none">' +
                t('hosp_manual') + '</a>' +
                '<a href="tel:112" style="flex:0 0 auto;padding:9px 16px;background:rgba(255,23,68,.08);border:1px solid rgba(255,23,68,.25);border-radius:9px;color:var(--accent);font-weight:700;font-size:.8rem;text-decoration:none">📞 112</a>' +
                '</div></div>';
        },
        { timeout: 10000, maximumAge: 60000, enableHighAccuracy: false }
    );
}

/* ===== VERİ — 22 kart (TR + EN) ===== */
var DATA = [
    {id:"cpr", i:"💓",
     t:{tr:"Kalp Masajı", en:"CPR / Chest Compressions"},
     do:{tr:["Kişiyi sert ve düz bir zemine yatırın","İki meme başı arasına her iki elinizi üst üste koyarak dakikada 100–120 kez, en az 5 cm derinliğinde baskı uygulayın","Kollarınızı dik tutun — tüm vücut ağırlığınızı kullanın","Her baskıdan sonra göğsün tamamen geri gelmesine izin verin"],
         en:["Lay the person on a firm flat surface","Place both hands on the centre of the chest and compress at least 5 cm deep, 100–120 times per minute","Keep arms straight — use your full body weight","Allow the chest to fully recoil after each compression"]},
     dont:{tr:["Nefes alan ya da bilinci açık kişiye uygulamayın","Yorulduğunuz için bırakmayın — başka biri varsa dönüşümlü yapın"],
           en:["Do not apply to a breathing or conscious person","Do not stop because you are tired — switch with someone if possible"]},
     n:{tr:"Doğru ritim için yukarıdaki CPR Metronom aracını kullanın — dakikada 100 ila 120 baskı. Yardım gelene kadar asla durmayın!",
        en:"Use the CPR Metronome tool above — 100 to 120 compressions per minute. Never stop until help arrives!"}},

    {id:"quake", i:"🌍",
     t:{tr:"Deprem Anı", en:"During an Earthquake"},
     do:{tr:["Çök, kapan, tutun: dizlerinize çökün, başınızı ve boynunuzu kollarınızla örtün, sabit eşyaya tutunun","Masa yoksa iç duvara yakın bir köşeye geçin","Sarsıntı bitene kadar bu pozisyonu koruyun"],
         en:["Drop, Cover, Hold: drop to your knees, cover your head and neck, hold onto something sturdy","If no table, move to an inside corner near an interior wall","Hold position until shaking stops"]},
     dont:{tr:["Sarsıntı sırasında asansöre binmeyin","Merdivene ya da dışarıya koşmayın — dökülen parçalar ve camlar tehlikelidir"],
           en:["Do not use the lift during shaking","Do not run to stairs or outside — falling debris and glass are dangerous"]},
     n:{tr:"Sarsıntı bitince sakin şekilde tahliye edin. Artçılar için açık alanda bekleyin.",
        en:"After shaking stops, evacuate calmly. Wait in an open area for aftershocks."}},

    {id:"heimlich", i:"🖐️",
     t:{tr:"Heimlich Manevrası", en:"Heimlich Manoeuvre"},
     do:{tr:["Arkasına geçip beline sarılın","Bir elinizle yumruk yapın, göbek ile göğüs kafesi arasına yerleştirin","Diğer elinizle kavrayıp içe yukarı güçlü çekişler yapın"],
         en:["Stand behind the person and wrap your arms around their waist","Make a fist with one hand and place it between the navel and ribcage","Grasp your fist with your other hand and thrust firmly inward and upward"]},
     dont:{tr:["Kişi öksürebiliyorsa dokunmayın — öksürük en etkili yöntemdir","Bebeklere karın baskısı uygulamayın"],
           en:["If the person can cough, do not interfere — coughing is most effective","Do not apply abdominal thrusts to infants"]},
     n:{tr:"Konuşamıyor, morarıyor, öksüremiyor ise saniyeler kritiktir — hemen başlayın.",
        en:"If they cannot speak, are turning blue, or cannot cough — seconds count. Start immediately."}},

    {id:"bleed", i:"🩸",
     t:{tr:"Ağır Kanama", en:"Severe Bleeding"},
     do:{tr:["Temiz bezle yaraya güçlü ve sürekli baskı uygulayın, 10 dakika boyunca bırakmayın","Yaralı uzvu mümkünse kalp seviyesinin üstüne kaldırın","Durdurulamayan kol veya bacak kanamasında yaranın 5 ila 8 cm üstüne turnike uygulayın ve saati not edin"],
         en:["Apply firm, continuous pressure with a clean cloth for 10 minutes without releasing","Elevate the injured limb above heart level if possible","For uncontrolled arm or leg bleeding, apply a tourniquet 5–8 cm above the wound and note the time"]},
     dont:{tr:["Kemiğe saplanmış cismi çıkarmayın — sabitleyip acile bırakın","Bezler kanlandığında çekip kaldırmayın, üstüne yeni bez ekleyin"],
           en:["Do not remove objects embedded in bone — stabilise and get to hospital","Do not remove soaked cloths — add fresh ones on top"]},
     n:{tr:"Turnike 2 saati geçmemeli. Uygulama saatini mutlaka not edin.",
        en:"A tourniquet should not remain for more than 2 hours. Always record the application time."}},

    {id:"fire", i:"🔥",
     t:{tr:"Yangın / Duman", en:"Fire / Smoke"},
     do:{tr:["Zemine yakın kalarak emekleyin — duman yukarıda birikir","Ağız ve burnu ıslak bezle kapatın","Kapıyı açmadan önce yüzeyine elinizin sırtıyla dokunun"],
         en:["Crawl low to the ground — smoke rises to the ceiling","Cover your mouth and nose with a wet cloth","Before opening a door, feel its surface with the back of your hand"]},
     dont:{tr:["Asansör kullanmayın","Kapı sıcaksa açmayın — odada kalıp pencereden yardım isteyin"],
           en:["Do not use the lift","If the door is hot, do not open it — stay in the room and signal from a window"]},
     n:{tr:"Duman zehirlenmesi yanıktan çok daha hızlı öldürür. Çıkış yoksa kapı aralığını ıslak bezle kapatın.",
        en:"Smoke inhalation kills far faster than burns. If no exit, seal door gaps with wet cloth."}},

    {id:"drown", i:"🏊",
     t:{tr:"Suda Boğulma", en:"Drowning"},
     do:{tr:["Sert ve düz zemine yatırın","Solunum yoksa kalp masajına hemen başlayın","Vücut ısısını korumak için kuru tutun ve üstünü örtün"],
         en:["Lay on a firm flat surface","If not breathing, start CPR immediately","Keep them dry and covered to preserve body temperature"]},
     dont:{tr:["Karnına basarak su çıkarmayı denemeyin — hem vakit kaybettirir hem de hava yolunu tıkar"],
           en:["Do not press the abdomen to expel water — it wastes time and blocks the airway"]},
     n:{tr:"Soğuk suda bile uzun süre bilinçsiz kalan kişiler kurtarılabilir — 112 gelene kadar kalp masajını bırakmayın.",
        en:"Even after prolonged unconsciousness in cold water, survival is possible — do not stop CPR until help arrives."}},

    {id:"elec", i:"⚡",
     t:{tr:"Elektrik Çarpması", en:"Electric Shock"},
     do:{tr:["Önce ana şalteri veya sigortayı indirin","Kabloyu tahta ya da plastik gibi yalıtkan nesneyle çekin","Kişi akımdan ayrıldıktan sonra güvenli zemine taşıyın; bilinç yoksa kalp masajı başlatın"],
         en:["First turn off the main switch or breaker","Use a non-conducting object such as wood or plastic to move the cable","Once free from current, move to safe ground; if unconscious, start CPR"]},
     dont:{tr:["Çıplak elle dokunmayın — siz de çarpılırsınız","Islak veya iletken zeminde durmayın"],
           en:["Do not touch with bare hands — you will also be electrocuted","Do not stand on wet or conductive surfaces"]},
     n:{tr:"Dışarıdan yanık görünmese bile iç organlar ciddi hasar almış olabilir. Mutlaka 112'yi arayın.",
        en:"Even without visible burns, internal organs may be severely damaged. Always call emergency services."}},

    {id:"poison", i:"⚠️",
     t:{tr:"Zehirlenme", en:"Poisoning"},
     do:{tr:["Orijinal kutu veya şişeyi saklayın — acil ekibine gösterin","114 Ulusal Zehir Danışma Hattını arayın","Kişi bilinçsizse kurtarma pozisyonuna yatırın"],
         en:["Keep the original container or bottle — show it to the emergency team","Call the National Poison Control Hotline","If unconscious, place in the recovery position"]},
     dont:{tr:["Zorla kusturmayın","Kimyasal veya asit içildiyse kusturmak yemek borusunu yeniden yakar"],
           en:["Do not induce vomiting","If chemicals or acid were swallowed, vomiting will burn the oesophagus again"]},
     n:{tr:"114'ü ararken kişinin kilosunu, alınan maddeyi ve ne kadar önce alındığını söyleyin.",
        en:"When calling Poison Control, state the person's weight, the substance taken, and how long ago."}},

    {id:"bone", i:"🦴",
     t:{tr:"Kırıklar", en:"Fractures"},
     do:{tr:["Kırık bölgeyi mümkün olan en az hareketle sabitleyin","Gazete, karton veya düz tahta ile atel yapın — kırık yerin altına ve üstüne gelecek şekilde bağlayın","Şişme ve ağrı için bölgeyi yükseltin, soğuk uygulayın"],
         en:["Immobilise the fractured area with minimal movement","Make a splint from newspaper, cardboard or a flat board — extend it above and below the fracture","Elevate and apply cold for swelling and pain"]},
     dont:{tr:["Kemiği yerine oturtmaya veya düzeltmeye çalışmayın","Kemik deriden çıkmışsa örtün fakat dokunmayın"],
           en:["Do not try to realign or straighten the bone","If bone protrudes through skin, cover it but do not touch"]},
     n:{tr:"Omurilik şüphesinde kişiyi hiç oynatmayın — 112'yi bekleyin.",
        en:"If spinal injury is suspected, do not move the person at all — wait for emergency services."}},

    {id:"faint", i:"😵",
     t:{tr:"Bayılma / Şok", en:"Fainting / Shock"},
     do:{tr:["Sırt üstü yatırın, ayakları 30 cm kaldırın","Kravat, kemer, dar giysiler gibi sıkan her şeyi gevşetin","Taze hava sağlayın"],
         en:["Lay on their back and raise the legs 30 cm","Loosen anything tight — tie, belt, restrictive clothing","Ensure fresh air"]},
     dont:{tr:["Tokat atmayın, sarsmayın","Su veya sıvı içirmeyin — bilinçsiz kişi aspire edebilir"],
           en:["Do not slap or shake them","Do not give water or fluids — an unconscious person may aspirate"]},
     n:{tr:"Bayılma 1 dakikadan uzun sürüyorsa, tekrar ediyorsa veya kafa travması şüphesi varsa 112'yi arayın.",
        en:"If fainting lasts more than 1 minute, recurs, or head trauma is suspected, call 112."}},

    {id:"sun", i:"☀️",
     t:{tr:"Güneş Çarpması", en:"Heatstroke"},
     do:{tr:["Hemen gölgeye veya serin ortama alın","Islak havlu ile boyun, koltuk altı ve kasıklara uygulama yapın","Bilinci açıksa azar azar tuzlu şekerli su içirin"],
         en:["Move immediately to shade or a cool environment","Apply wet towels to the neck, armpits, and groin","If conscious, give small sips of cool salted water"]},
     dont:{tr:["Buzlu suya sokmayın ya da buz uygulamayın — ani damar kasılması riski"],
           en:["Do not submerge in ice water or apply ice — risk of sudden vascular spasm"]},
     n:{tr:"Vücut sıcaklığı 40 derece üstü veya kişi yanıt vermiyorsa 112'yi arayın.",
        en:"If body temperature exceeds 40°C or the person is unresponsive, call 112."}},

    {id:"tsunami", i:"🌊",
     t:{tr:"Tsunami", en:"Tsunami"},
     do:{tr:["Deniz aniden çekiliyorsa hemen en yakın yüksek noktaya çıkın","Sahilden en az 3 km uzaklaşın veya 30 metre yüksekliğe çıkın","Resmi tehlike geçti açıklaması olmadan kıyıya inmeyin"],
         en:["If the sea suddenly recedes, immediately move to the nearest high ground","Move at least 3 km from the coast or reach 30 metres elevation","Do not return to the shore without an official all-clear"]},
     dont:{tr:["Dalgayı izlemek için sahilde kalmayın","İlk dalgadan sonra geri dönmeyin — ardından daha güçlü dalgalar gelebilir"],
           en:["Do not stay on the beach to watch the wave","Do not return after the first wave — stronger waves may follow"]},
     n:{tr:"Her zaman resmi uyarı kanallarını takip edin.",
        en:"Always follow official warning channels."}},

    {id:"land", i:"⛰️",
     t:{tr:"Heyelan", en:"Landslide"},
     do:{tr:["Açık ve geniş bir alana kaçın","Binadaysanız sağlam bir eşyanın yanına çömelin ve başınızı koruyun","Kurtarma için ıslık çalın veya sert nesneye vurun — bağırmaktan kaçının"],
         en:["Escape to an open, wide area","If indoors, crouch near a sturdy object and protect your head","To signal rescuers, whistle or knock on a hard surface — avoid shouting"]},
     dont:{tr:["Yamaç eteklerinde veya dere yataklarında beklemeyin"],
           en:["Do not wait at the base of slopes or in riverbeds"]},
     n:{tr:"Heyelan geçtikten sonra da geri dönmeyin — ikincil kayma riski devam eder.",
        en:"Do not return after the slide — risk of secondary slides continues."}},

    {id:"avalanche", i:"❄️",
     t:{tr:"Çığ", en:"Avalanche"},
     do:{tr:["Yüzme hareketi yaparak yüzeyde kalmaya çalışın","Durduğunuzda ağzınızın önünde hava cebi açın","Elinizi yukarı uzatarak bulunduğunuzu işaret edin"],
         en:["Use swimming motions to stay near the surface","Once stopped, create an air pocket in front of your mouth","Extend one hand upward to signal your location"]},
     dont:{tr:["Bağırıp oksijen harcamayın — sakin ve düzenli nefes alın"],
           en:["Do not shout and waste oxygen — breathe calmly and steadily"]},
     n:{tr:"Hangi yönün aşağı olduğunu bulmak için salya akmasına bakın. Kurtarıcılar gelene kadar sakin kalın.",
        en:"Let saliva run to find which way is down. Stay calm until rescuers arrive."}},

    {id:"allergy", i:"🐝",
     t:{tr:"Alerjik Şok", en:"Anaphylaxis / Allergic Shock"},
     do:{tr:["İğneyi kartla kazıyarak çıkarın","112'yi hemen arayın","Epipen varsa uyluğun dış yanına, kıyafet üzerinden bile uygulayın","Sırt üstü yatırın, bacakları 30 cm kaldırın"],
         en:["Scrape out the sting with a card","Call 112 immediately","If an EpiPen is available, inject into the outer thigh, even through clothing","Lay on their back and raise legs 30 cm"]},
     dont:{tr:["İğneyi cımbızla sıkmayın — zehir kesesini boşaltırsınız","Kişiyi ayağa kaldırmayın"],
           en:["Do not squeeze the sting with tweezers — this empties the venom sac","Do not stand the person upright"]},
     n:{tr:"Nefes darlığı, ses kısıklığı veya bilinç değişikliği, saniyeler kritiktir. Epipen yoksa 112 gelene kadar yalnız bırakmayın.",
        en:"Difficulty breathing, hoarseness, or altered consciousness — seconds count. Without an EpiPen, do not leave them alone until 112 arrives."}},

    {id:"stroke", i:"🧠",
     t:{tr:"İnme Belirtileri", en:"Stroke Signs"},
     do:{tr:["Fast testini uygulayın: yüz sarkması, kol güçsüzlüğü, konuşma bozukluğu, zaman","Bir belirti bile varsa derhal 112'yi arayın","Kişiyi sakin ve konforlu tutun"],
         en:["Apply the FAST test: Face drooping, Arm weakness, Speech difficulty, Time to call","Even one symptom means call 112 immediately","Keep the person calm and comfortable"]},
     dont:{tr:["Aspirin veya başka ilaç vermeyin — beyin kanaması olabilir","Yemek veya içecek vermeyin"],
           en:["Do not give aspirin or any medication — there may be brain haemorrhage","Do not give food or drink"]},
     n:{tr:"İnmede her dakika 1,9 milyon sinir hücresi kaybedilir. Zaman eşittir beyin — erken müdahale kalıcı hasarı önler.",
        en:"Every minute of stroke = 1.9 million neurones lost. Time is brain — early intervention prevents permanent damage."}},

    {id:"burn", i:"🌡️",
     t:{tr:"Yanıklar", en:"Burns"},
     do:{tr:["Yanığı 10 ila 20 dakika boyunca ılık akan su altında soğutun","Steril bez veya temiz kıyafetle örtün","El ayası büyüklüğünden geniş yanıklarda 112'yi arayın"],
         en:["Cool the burn under lukewarm running water for 10–20 minutes","Cover with sterile gauze or clean clothing","Call 112 for burns larger than the palm of a hand"]},
     dont:{tr:["Buz, yoğurt, diş macunu veya yağ uygulamayın","Kabarcıkları patlatmayın","Yanığa yapışmış kıyafeti zorla çıkarmayın"],
           en:["Do not apply ice, yoghurt, toothpaste, or oil","Do not burst blisters","Do not forcibly remove clothing stuck to the burn"]},
     n:{tr:"Kimyasal yanıkta önce 20 dakika akan su, sonra 112. Elektrik yanığında önce gücü kesin.",
        en:"For chemical burns: 20 minutes of running water first, then 112. For electrical burns: cut power first."}},

    {id:"diabetic", i:"🍬",
     t:{tr:"Diyabetik Kriz", en:"Diabetic Crisis"},
     do:{tr:["Bilinç açıksa 15 gram hızlı karbonhidrat verin: 4 şeker küpü, 150 ml meyve suyu veya 1 çay kaşığı bal","15 dakika bekleyin, düzelmezse tekrarlayın","Bilinç kapalıysa yan yatırın ve 112'yi arayın"],
         en:["If conscious, give 15 g fast carbohydrates: 4 sugar cubes, 150 ml fruit juice, or 1 tsp honey","Wait 15 minutes; if no improvement, repeat","If unconscious, place in recovery position and call 112"]},
     dont:{tr:["Bilinçsiz kişinin ağzına bir şey koymayın — boğulabilir","İnsülin enjekte etmeyin"],
           en:["Do not put anything in the mouth of an unconscious person — choking risk","Do not inject insulin"]},
     n:{tr:"Terleme, titreme, solgunluk, düşük kan şekeri. Bilinç kaybı ve meyve kokusu, yüksek kan şekeri. İkisinde de 112.",
        en:"Sweating, trembling, pallor = low blood sugar. Unconsciousness and fruity odour = high blood sugar. Call 112 for either."}},

    {id:"panic", i:"😰",
     t:{tr:"Panik Atak", en:"Panic Attack"},
     do:{tr:["4 7 8 nefes: 4 sayarak al, 7 sayarak tut, 8 sayarak ver","Sakin sesle tehlike yok, bu geçecek deyin","Kişiyi oturtun veya yere bağdaş kurdurun"],
         en:["4-7-8 breathing: inhale for 4, hold for 7, exhale for 8","Calmly say: there is no danger, this will pass","Sit the person down or have them sit cross-legged on the floor"]},
     dont:{tr:["Sakin ol, abartıyorsun gibi küçümseyici şeyler söylemeyin","Kalabalıkta bırakmayın"],
           en:["Do not say 'calm down' or 'you're overreacting'","Do not leave them in a crowd"]},
     n:{tr:"Panik atak 10 dakikada zirveye ulaşır, genellikle 20 ila 30 dakikada geçer. Fiziksel semptomlar gerçektir — asla küçümseme.",
        en:"Panic attacks peak at 10 minutes and usually pass in 20–30 minutes. The physical symptoms are real — never dismiss them."}},

    {id:"hypothermia", i:"🥶",
     t:{tr:"Hipotermi", en:"Hypothermia"},
     do:{tr:["Islak kıyafetleri dikkatlice çıkarın, kuru örtülerle sarın","Göğüs, boyun ve kasık bölgesini ısıtın — koltuk altına ılık su şişesi koyabilirsiniz","Bilinci açıksa ılık tatlı içecek verin"],
         en:["Carefully remove wet clothing and wrap in dry blankets","Warm the chest, neck, and groin — a warm water bottle in the armpit can help","If conscious, give a warm sweet drink"]},
     dont:{tr:["Elleri, kolları veya ayakları ovmayın — periferik soğuk kan kalbi durdurabilir","Sıcak su banyosuna sokmayın"],
           en:["Do not rub hands, arms, or legs — cold peripheral blood can stop the heart","Do not place in a hot water bath"]},
     n:{tr:"Vücut sıcaklığı 32 derece altına düştüğünde kalp ritim bozukluğu başlar. Kişi tepkisiz görünse bile kalp masajı başlatın ve 112'yi arayın.",
        en:"Below 32°C cardiac arrhythmia begins. Even if the person appears unresponsive, start CPR and call 112."}},

    {id:"gas", i:"💨",
     t:{tr:"Doğalgaz Kaçağı", en:"Gas Leak"},
     do:{tr:["Odadaki herkesi derhal dışarı çıkarın","Tüm pencere ve kapıları açarak havalandırın","Binadan uzaklaştıktan sonra 187 veya gaz şirketini arayın"],
         en:["Immediately evacuate everyone from the room","Open all windows and doors to ventilate","Once outside the building, call 187 or the gas company"]},
     dont:{tr:["Hiçbir elektrik anahtarına veya cihaza dokunmayın — kıvılcım patlamaya yol açar","Ev telefonunu kullanmayın; cep telefonunu ancak dışarıda kullanın"],
           en:["Do not touch any electrical switches or appliances — sparks cause explosions","Do not use the landline; use a mobile only when outside"]},
     n:{tr:"Gaz kokusu alıyorsanız saniyeler önemlidir. Elektrik dışında hiçbir şeye dokunmadan çıkın.",
        en:"If you smell gas, every second counts. Leave without touching anything except to close the door."}},

    {id:"child_fever", i:"🌡",
     t:{tr:"Çocukta Yüksek Ateş", en:"High Fever in Children"},
     do:{tr:["38,5 derece altı: ılık ıslak bezle vücudu silin, bol sıvı verin","38,5 derece üstü: doktora danışarak uygun dozda ateş düşürücü verin","Oda sıcaklığını 20 ila 22 derece arasında tutun, hafif giydirin"],
         en:["Below 38.5°C: sponge the body with lukewarm water and give plenty of fluids","Above 38.5°C: give appropriate fever medication after consulting a doctor","Keep room temperature 20–22°C and dress the child lightly"]},
     dont:{tr:["Soğuk suya sokmayın veya buz uygulamayın","Aspirin vermeyin — çocuklarda Reye sendromu riski var"],
           en:["Do not immerse in cold water or apply ice","Do not give aspirin — risk of Reye's syndrome in children"]},
     n:{tr:"3 aydan küçük bebekte 38 derece üstü ateş, derhal acile. Her yaşta 40 derece üstü, kasılma veya solunum güçlüğü, 112.",
        en:"In babies under 3 months, fever above 38°C = immediate A&E. Any age: above 40°C, seizures, or breathing difficulty = 112."}},

    {id:"wildfire", i:"🌲🔥",
     t:{tr:"Orman Yangını", en:"Wildfire"},
     do:{tr:["Rüzgar yönünü belirleyin — rüzgara karşı değil, yana doğru kaçın","Alçak pozisyonda zemine yakın yürüyün — duman yukarıda birikir","Su kanalı, yol veya taşlık alan gibi yanmaz bir alana sığının","187 Orman Yangın İhbar Hattını veya 112'yi hemen arayın","Mümkünse ıslak bez ile ağız ve burnunuzu kapatın"],
         en:["Identify wind direction — flee sideways, not against the wind","Move low to the ground — smoke rises","Shelter in a non-combustible area: water channel, road, or rocky terrain","Call 187 (Forest Fire Line) or 112 immediately","Cover mouth and nose with a wet cloth if possible"]},
     dont:{tr:["Araçla çıkış yoksa arabada kalmayın — yakıt deposu patlar","Yüksek ota veya çalılığa doğru koşmayın","Yangına sırt dönüp doğrudan uzaklaşmayın — ateş ilerleyişi düşündüğünüzden hızlıdır"],
           en:["Do not stay in your car if there is no exit route — the fuel tank can explode","Do not run toward tall grass or shrubs","Do not turn your back and run directly away — fire moves faster than expected"]},
     n:{tr:"2025–2026 yaz döneminde Türkiye'de 40°C üstü sıcaklıklar ve kuvvetli rüzgarlarla yangın riski kritik seviyelere ulaştı. Özellikle Ege, Akdeniz ve Karadeniz bölgesinde en yüksek alarm durumu geçerlidir.",
        en:"In the 2025–2026 summer season, temperatures above 40°C and strong winds pushed wildfire risk to critical levels in Turkey, especially in the Aegean, Mediterranean, and Black Sea regions."}},

    {id:"heartattack", i:"🫀",
     t:{tr:"Kalp Krizi Belirtileri", en:"Heart Attack Signs"},
     do:{tr:["FAST testini uygulayın: göğüste baskı/sıkışma hissi, sol kola, çeneye veya sırta yayılan ağrı varsa 112'yi hemen arayın","Kişiyi yere oturturun veya yatırın — sakin ve hareketsiz tutun","Aspirin alerjisi yoksa 300 mg çiğneyin (yutmayın)","112 gelene kadar kişinin yanında kalın, bilincini ve nefesini izleyin"],
         en:["Apply FAST: chest pressure/tightness, pain spreading to left arm, jaw or back → call 112 immediately","Sit or lay the person down — keep them still and calm","Unless allergic, chew (do not swallow) 300 mg aspirin","Stay with the person until 112 arrives, monitor breathing and consciousness"]},
     dont:{tr:["'Geçer' deyip beklemeyin — her dakika kalp kası ölür","Kişiyi yürütmeyin veya hareket ettirmeyin","Yemek yedirmeyin, su içirmeyin"],
           en:["Do not wait thinking 'it will pass' — every minute, heart muscle dies","Do not make the person walk or exert effort","Do not give food or drink"]},
     n:{tr:"Kalp krizi ile kalp durması farklıdır. Kalp krizi'nde kişi genellikle bilinçli ama ağrı içindedir. Bilinç ve nefes yoksa CPR başlatın.",
        en:"Heart attack and cardiac arrest are different. In a heart attack the person is usually conscious but in pain. If unconscious and not breathing, start CPR."}},

    {id:"asthma", i:"🫁",
     t:{tr:"Astım Krizi", en:"Asthma Attack"},
     do:{tr:["Kişiyi dik oturur pozisyona getirin — öne hafif eğik, elleri dizlerinde","Varsa mavi/kısa etkili inhaler (salbutamol) kullandırın — 4 puf, her puf arası 1 dakika","İnhaler yoksa 112'yi hemen arayın","Sakin kalmasını sağlayın — panik nefes darlığını artırır","5 dakikada düzelme yoksa 112'yi arayın ve ikinci doz verin"],
         en:["Sit the person upright, leaning slightly forward, hands on knees","If available, use a blue/reliever inhaler (salbutamol) — 4 puffs, 1 minute apart","If no inhaler, call 112 immediately","Keep them calm — panic worsens breathlessness","If no improvement after 5 minutes, call 112 and give a second dose"]},
     dont:{tr:["Kişiyi yatırmayın — oturur pozisyon nefes almayı kolaylaştırır","Tetikleyicilerden (duman, koku, allerjen) uzaklaştırın","İnhaleri fazla hızlı uygulamayın"],
           en:["Do not lay the person flat — sitting upright eases breathing","Remove from triggers (smoke, strong smells, allergens)","Do not apply puffs too quickly"]},
     n:{tr:"Kriz sırasında dudaklar veya parmak uçları morarıyorsa (siyanoz), nefes çok zorlanıyorsa ya da konuşamıyorsa — ağır kriz, derhal 112.",
        en:"If lips or fingertips turn blue (cyanosis), breathing is very laboured, or the person cannot speak — severe attack, call 112 immediately."}},

    {id:"childbirth", i:"🤰",
     t:{tr:"Acil Doğum (Ambulans Gelmeden)", en:"Emergency Childbirth"},
     do:{tr:["112'yi hemen arayın — operatör sizi adım adım yönlendirecek","Anneyi sırt üstü yatırın, dizlerini kıvırıp ayaklarını yere bassın","Temiz çarşaf, havlu ve varsa steril eldiven hazırlayın","Bebek çıkarken başını hafifçe destekleyin — itmeyip doğal gelişini bekleyin","Doğduktan sonra bebeği anne göğsüne koyun, sıcak tutun"],
         en:["Call 112 immediately — the operator will guide you step by step","Lay the mother on her back, knees bent and feet flat","Prepare clean sheets, towels and sterile gloves if available","As the baby emerges, gently support the head — do not push, let it come naturally","After birth, place baby on mother's chest and keep warm"]},
     dont:{tr:["Göbek bağını makasla veya kirli aletle kesmeyin — 112 gelene kadar bekleyin","Bebeği aniden çekmeyin","Plasentayı itmek için karna bastırmayın"],
           en:["Do not cut the umbilical cord with scissors or unclean tools — wait for 112","Do not pull the baby suddenly","Do not press on the abdomen to expel the placenta"]},
     n:{tr:"Doğum sonrası anne çok kan kaybediyorsa göbeğe nazikçe masaj yapın ve kanamanın üstüne baskı uygulayın. 112 operatöründen hiç kopmayın.",
        en:"If the mother bleeds heavily after birth, gently massage the uterus and apply pressure to the wound. Stay on the line with the 112 operator throughout."}}
];

/* ===== DURUM DEĞİŞKENLERİ ===== */
var toastTimer = null;
var synth = (typeof window.speechSynthesis !== 'undefined') ? window.speechSynthesis : null;
var speakResumeTimer = null;
var currentSpeakBtn = null;
var whistleCtx = null;
var whistleOsc = null;
var whistleGain = null;
var whistleOn  = false;
var selectedGroup = null;
var selectedRh = null;
var userLocation = null;
var lastAlertedQuake = null;
var alertedDisasters = {};

/* ===== TOAST ===== */
function showToast(msg, ms) {
    ms = ms || 2800;
    var el = document.getElementById('toast');
    if (!el) return;
    clearTimeout(toastTimer);
    el.classList.remove('show');
    /* Force reflow so animation restarts cleanly */
    void el.offsetWidth;
    el.textContent = msg;
    el.classList.add('show');
    toastTimer = setTimeout(function(){
        el.classList.remove('show');
    }, ms);
}

/* ===== KARTLARI RENDER ===== */
var appGridListenersAdded = false;
function render() {
    document.getElementById('appGrid').innerHTML = DATA.map(function(g, i) {
        var title = typeof g.t === 'object' ? (g.t[currentLang] || g.t.tr) : g.t;
        return '<div class="card-grid-item" data-idx="'+i+'" role="button" tabindex="0" aria-label="'+escHtml(title)+'">' +
               '<div class="card-emoji" aria-hidden="true">'+g.i+'</div>' +
               '<div class="card-title">'+escHtml(title)+'</div>' +
               '</div>';
    }).join('');
    if (!appGridListenersAdded) {
        appGridListenersAdded = true;
        document.getElementById('appGrid').addEventListener('click', function(e) {
            var card = e.target.closest('.card-grid-item');
            if (card) openModal(parseInt(card.dataset.idx, 10));
        });
        document.getElementById('appGrid').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                var card = e.target.closest('.card-grid-item');
                if (card) openModal(parseInt(card.dataset.idx, 10));
            }
        });
    }
}

/* ===== ARAMA ===== */
function filterCards() {
    var q = document.getElementById('searchInput').value.trim().toLowerCase();
    var cards = document.querySelectorAll('.card-grid-item');
    var visibleCount = 0;
    cards.forEach(function(card) {
        var idx = parseInt(card.dataset.idx, 10);
        var g = DATA[idx];
        var lang = currentLang;
        var title = typeof g.t === 'object' ? (g.t[lang] || g.t.tr) : g.t;
        var doArr = typeof g.do === 'object' && !Array.isArray(g.do) ? (g.do[lang] || g.do.tr) : g.do;
        var dontArr = typeof g.dont === 'object' && !Array.isArray(g.dont) ? (g.dont[lang] || g.dont.tr) : g.dont;
        var note = typeof g.n === 'object' ? (g.n[lang] || g.n.tr) : g.n;
        var haystack = (title + ' ' + doArr.join(' ') + ' ' + dontArr.join(' ') + ' ' + note).toLowerCase();
        var match = !q || haystack.indexOf(q) !== -1;
        card.classList.toggle('hidden', !match);
        if (match) visibleCount++;
    });
    document.getElementById('noResult').style.display = visibleCount === 0 ? 'block' : 'none';
}

/* ===== MODAL ===== */
function openModal(idx) {
    if (idx < 0 || idx >= DATA.length) return;
    stopSpeech();
    var g = DATA[idx];
    var lang = currentLang;
    var title  = typeof g.t === 'object' ? (g.t[lang] || g.t.tr) : g.t;
    var doList = typeof g.do === 'object' && !Array.isArray(g.do) ? (g.do[lang] || g.do.tr) : g.do;
    var dontList = typeof g.dont === 'object' && !Array.isArray(g.dont) ? (g.dont[lang] || g.dont.tr) : g.dont;
    var note   = typeof g.n === 'object' ? (g.n[lang] || g.n.tr) : g.n;
    var doHtml   = doList.map(function(x){ return '<li>✅ <span>'+escHtml(x)+'</span></li>'; }).join('');
    var dontHtml = dontList.map(function(x){ return '<li>❌ <span>'+escHtml(x)+'</span></li>'; }).join('');
    var extra = g.id === 'cpr'
        ? '<div class="cpr-anim">' + t('modal_cpr_press') + '</div>' +
          '<p style="text-align:center;font-size:.8rem;color:var(--sub);margin-bottom:15px">' + t('modal_cpr_note') + '</p>'
        : '';
    document.getElementById('modalBody').innerHTML =
        '<button class="voice-btn" id="speakBtn"><span>🔊</span> ' + t('modal_listen') + '</button>' +
        '<h2 style="color:var(--accent);margin-bottom:20px;font-weight:900;font-size:1.4rem;line-height:1.3">' + g.i + ' ' + escHtml(title) + '</h2>' +
        extra +
        '<div class="guide-box"><b>' + t('modal_do') + '</b><ul>' + doHtml + '</ul></div>' +
        '<div class="guide-box"><b>' + t('modal_dont') + '</b><ul>' + dontHtml + '</ul></div>' +
        '<div class="important-note">💡 ' + escHtml(note) + '</div>';
    var btn = document.getElementById('speakBtn');
    var speechText = buildSpeechText({t:title, do:doList, dont:dontList, n:note});
    btn.addEventListener('click', function() { speak(speechText, btn); });
    document.getElementById('mainOverlay').style.display = 'flex';
    document.getElementById('modalBox').scrollTop = 0;
    if (a11yState && a11yState.autoSpeak) {
        setTimeout(function() { speak(speechText, btn); }, 400);
    }
}
function closeModal() {
    stopSpeech();
    document.getElementById('mainOverlay').style.display = 'none';
}
function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ===== SESLİ OKUMA ===== */
var cachedVoices = [];
function loadVoices() {
    var v = synth ? synth.getVoices() : [];
    if (v.length) cachedVoices = v;
}
function cleanForSpeech(text) {
    return text
        .replace(/[\u{1F300}-\u{1FFFF}]/gu, ' ')
        .replace(/[\u2600-\u26FF\u2700-\u27BF]/g, ' ')
        .replace(/[✅❌💡🔊⏹⚠]/g, ' ')
        .toLowerCase()
        .replace(/(\d)\s*[–-]\s*(\d)/g, '$1 ile $2')
        .replace(/\s*[–—]\s*/g, '. ')
        .replace(/→/g, '. ').replace(/·/g, '. ')
        .replace(/°c/g, ' derece').replace(/°/g, ' derece ')
        .replace(/\//g, ' veya ')
        .replace(/\bcpr\b/gi, 'kalp masajı')
        .replace(/\bsos\b/gi, 'yardım çağrısı')
        .replace(/\blpg\b/gi, 'el pi ji')
        .replace(/\bfast\b/gi, 'hızlı test')
        .replace(/\bepipen\b/gi, 'epi pen')
        .replace(/\(([^)]+)\)/g, ', $1,')
        .replace(/[''""]/g, ' ')
        .replace(/,\s*,/g, ',')
        .replace(/\.\s*\./g, '.')
        .replace(/([.,;!?])\s*/g, '$1 ')
        .replace(/\s{2,}/g, ' ')
        .trim();
}
function buildSpeechText(g) {
    var sentences = [];
    var isEn = currentLang === 'en';
    sentences.push(g.t + '.');
    sentences.push(isEn ? 'What to do.' : 'Yapılacaklar.');
    g.do.forEach(function(x) {
        sentences.push(x.replace(/\.$/, '').trim() + '.');
    });
    sentences.push(isEn ? 'What not to do.' : 'Yapılmayacaklar.');
    g.dont.forEach(function(x) {
        sentences.push(x.replace(/\.$/, '').trim() + '.');
    });
    sentences.push((isEn ? 'Important note. ' : 'Önemli bilgi. ') + g.n);
    return cleanForSpeech(sentences.join('  '));
}
function stopSpeech() {
    if (synth) synth.cancel();
    clearInterval(speakResumeTimer);
    speakResumeTimer = null;
    if (currentSpeakBtn) {
        currentSpeakBtn.innerHTML = '<span>🔊</span> ' + t('modal_listen');
        currentSpeakBtn.style.background = '';
        currentSpeakBtn = null;
    }
}
var isSpeakingTTS = false;
function speak(text, btn) {
    if (isSpeakingTTS || (synth && synth.speaking)) { stopSpeech(); return; }
    if (!btn) { speakWithOptimizedTTS(text); return; }
    currentSpeakBtn = btn;
    if (btn) { btn.innerHTML = '<span>⏹</span> ' + t('modal_stop'); btn.style.background = isDark ? '#1a0305' : '#fff0f2'; btn.style.borderColor = 'rgba(255,23,68,.3)'; btn.style.color = isDark ? '#FF5370' : '#d32f2f'; }
    speakWithOptimizedTTS(text, btn);
}
function speakWithOptimizedTTS(text, btn) {
    if (!synth) {
        console.warn('[TTS] SpeechSynthesis desteklenmiyor');
        showToast('⚠️ Sesli okuma desteklenmiyor');
        if (btn) stopSpeech();
        return;
    }
    if (!cachedVoices.length) loadVoices();
    var isAndroid = /Android/i.test(navigator.userAgent);
    var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'tr-TR';
    u.rate = isAndroid ? 0.9 : (isIOS ? 0.85 : 0.87);
    u.pitch = 1.0;
    u.volume = 1.0;
    var trVoice = getTurkishVoice();
    if (trVoice) u.voice = trVoice;
    u.onstart = function() { console.log('[TTS] Konuşma başladı'); };
    u.onend = function() { console.log('[TTS] Konuşma bitti'); stopSpeech(); };
    u.onerror = function(e) {
        if (e.error !== 'interrupted' && e.error !== 'canceled') {
            console.error('[TTS] Hata:', e.error);
            showToast('⚠️ Ses çıkışı hatası: ' + (e.error || 'Bilinmeyen'));
        }
        stopSpeech();
    };
    try {
        synth.speak(u);
        clearInterval(speakResumeTimer);
        speakResumeTimer = setInterval(function() {
            if (!synth || !synth.speaking) { clearInterval(speakResumeTimer); return; }
            synth.pause();
            synth.resume();
        }, 10000);
    } catch(err) {
        console.error('[TTS] Speak hatası:', err);
        stopSpeech();
    }
}
function getTurkishVoice() {
    if (!cachedVoices || !cachedVoices.length) return null;
    var i, v;
    for (i = 0; i < cachedVoices.length; i++) {
        v = cachedVoices[i];
        if (v.lang.startsWith('tr')) {
            if (v.name && v.name.toLowerCase().includes('google')) return v;
        }
    }
    for (i = 0; i < cachedVoices.length; i++) {
        if (cachedVoices[i].name && cachedVoices[i].name.toLowerCase().includes('google')) {
            return cachedVoices[i];
        }
    }
    for (i = 0; i < cachedVoices.length; i++) {
        if (cachedVoices[i].lang.startsWith('tr')) {
            return cachedVoices[i];
        }
    }
    return null;
}

/* ===== KAN GRUBU ===== */
function showBloodGroup() {
    var saved = '';
    try { saved = localStorage.getItem('vitalium_blood_group') || ''; } catch(e) {}
    if (saved) {
        var match = saved.match(/^(A|B|AB|0)([+-])$/);
        if (match) {
            selectedGroup = match[1];
            selectedRh = match[2];
        } else {
            selectedGroup = null;
            selectedRh = null;
        }
    } else {
        selectedGroup = null;
        selectedRh = null;
    }
    document.getElementById('bloodGroupOverlay').style.display = 'flex';
    updateBloodSelectionUI();
}
function updateBloodSelectionUI() {
    document.querySelectorAll('.blood-option').forEach(btn => {
        var group = btn.dataset.group;
        btn.classList.toggle('selected', selectedGroup === group);
    });
    document.querySelectorAll('.rh-option').forEach(btn => {
        var rh = btn.dataset.rh;
        btn.classList.toggle('selected', selectedRh === rh);
    });
}
function closeBloodGroupModal() {
    document.getElementById('bloodGroupOverlay').style.display = 'none';
}
function selectBloodGroup(group) {
    selectedGroup = group;
    updateBloodSelectionUI();
}
function selectRh(rh) {
    selectedRh = rh;
    updateBloodSelectionUI();
}
function saveBloodGroup() {
    if (!selectedGroup || !selectedRh) {
        showToast('Lütfen kan grubu ve Rh faktörünü seçin.');
        return;
    }
    var blood = selectedGroup + selectedRh;
    localStorage.setItem('vitalium_blood_group', blood);
    showToast('🩸 Kan grubu kaydedildi: ' + blood);
    updateBloodGroupButton();
    closeBloodGroupModal();
}
function updateBloodGroupButton() {
    let saved = '';
    try { saved = localStorage.getItem('vitalium_blood_group') || ''; } catch(e) {}
    let txt = document.getElementById('bgTxt');
    txt.innerText = saved || 'KAN GRUBU';
}

/* ===== KONUM YARDIMCI FONKSİYONLARI ===== */
/* IP bazlı konum — GPS engelliyken fallback */
function getLocationByIP(callback) {
    fetch('https://ipapi.co/json/')
        .then(function(r){ return r.json(); })
        .then(function(d) {
            if (d && d.latitude && d.longitude) {
                callback({
                    latitude: d.latitude,
                    longitude: d.longitude,
                    city: d.city || d.region || '',
                    byIP: true
                });
            } else { callback(null); }
        })
        .catch(function(){ callback(null); });
}

/* Konum al: önce GPS, başarısız olursa IP */
function getLocationWithFallback(onSuccess, onFail, opts) {
    if (navigator.geolocation) {
        var permDenied = false;
        navigator.geolocation.getCurrentPosition(
            function(pos) {
                onSuccess({
                    latitude: pos.coords.latitude,
                    longitude: pos.coords.longitude,
                    city: '',
                    byIP: false
                });
            },
            function(err) {
                /* Permissions Policy veya kullanıcı reddi → IP fallback */
                getLocationByIP(function(loc) {
                    if (loc) { onSuccess(loc); }
                    else { if (onFail) onFail(err); }
                });
            },
            opts || {timeout: 8000, maximumAge: 300000, enableHighAccuracy: false}
        );
    } else {
        getLocationByIP(function(loc) {
            if (loc) { onSuccess(loc); }
            else { if (onFail) onFail(null); }
        });
    }
}
function getDistanceInKm(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLon = (lon2 - lon1) * Math.PI / 180;
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}
function requestUserLocation() {
    getLocationWithFallback(
        function(loc) {
            userLocation = { lat: loc.latitude, lng: loc.longitude };
        },
        function() {},
        { timeout: 8000, maximumAge: 300000, enableHighAccuracy: false }
    );
}
function checkNearbyDisasters(quakes) {
    if (!userLocation || !quakes || !quakes.length) return;
    quakes.forEach(function(quake) {
        var mag = parseFloat(quake.mag || quake.magnitude || 0);
        var lat = parseFloat(quake.lat || quake.latitude || 0);
        var lng = parseFloat(quake.lon || quake.longitude || 0);
        var loc = quake.title || quake.location || quake.place || 'Bilinmeyen Lokasyon';
        if (mag >= 5.0 && lat && lng) {
            var distance = getDistanceInKm(userLocation.lat, userLocation.lng, lat, lng);
            if (distance <= 500) {
                var quakeKey = mag.toFixed(1) + '_' + lat.toFixed(2) + '_' + lng.toFixed(2);
                if (!alertedDisasters[quakeKey]) {
                    alertedDisasters[quakeKey] = true;
                    var msg = '🌍 DEPREM UYARISI: ' + mag.toFixed(1) + ' şiddetinde deprem! Bölge: ' + loc.substring(0, 50) + 
                              ' (Uzaklık: ' + Math.round(distance) + 'km) - Güvenli alanlara tahliye edin!';
                    triggerEmergencyAlert(msg, 15000);
                    sendPushNotification('🌍 DEPREM - ' + mag.toFixed(1) + ' Şiddeti', 
                        'Bölge: ' + loc.substring(0, 40) + ' | Uzaklık: ' + Math.round(distance) + 'km');
                }
            }
        }
    });
}

/* ===== BİLDİRİM İZNİ + PUSH ===== */
function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
        setTimeout(function() {
            Notification.requestPermission().then(function(perm) {
                if (perm === 'granted') {
                    console.log('[BİLDİRİM] İzin verildi');
                    showToast('🔔 Deprem bildirimleri aktif!', 3000);
                }
            });
        }, 3000);
    }
}
function sendPushNotification(title, body) {
    if (!('Notification' in window)) return;
    var iconSVG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23e11d48' rx='48'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle' fill='white'%3E❤️%3C/text%3E%3C/svg%3E";
    var notifOptions = {
        body: body,
        icon: iconSVG,
        badge: iconSVG,
        tag: 'vitalium-quake-' + Date.now(),
        requireInteraction: true,
        vibrate: [500, 300, 500, 200, 500],
        silent: false
    };
    function showViaServiceWorker() {
        navigator.serviceWorker.ready.then(function(reg) {
            reg.showNotification(title, notifOptions);
        }).catch(function(err) {
            try { new Notification(title, notifOptions); } catch(_) {}
        });
    }
    if (Notification.permission === 'granted') {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            showViaServiceWorker();
        } else if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(showViaServiceWorker).catch(function() {
                try { new Notification(title, notifOptions); } catch(_) {}
            });
        } else {
            try { new Notification(title, notifOptions); } catch(_) {}
        }
    } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(function(perm) {
            if (perm === 'granted') {
                if ('serviceWorker' in navigator) {
                    showViaServiceWorker();
                } else {
                    try { new Notification(title, notifOptions); } catch(_) {}
                }
            }
        });
    } else {
        showToast('🌍 ' + title + ' — ' + body, 8000);
    }
}

/* ===== DEPREM VERİLERİ ===== */
function fetchWithTimeout(url, ms) {
    var ctrl = new AbortController();
    var id = setTimeout(function(){ ctrl.abort(); }, ms);
    return fetch(url, { signal: ctrl.signal }).finally(function(){ clearTimeout(id); });
}

/* Paylaşılan render + kontrol fonksiyonları */
var _quakeRenderRows, _quakeSetUpdateTime;

function initQuakeHelpers() {
    var list = document.getElementById('quakeList');
    var src  = document.getElementById('qSrc');
    _quakeSetUpdateTime = function(label) {
        var now = new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
        if (src) src.textContent = label + ' · ' + now;
    };
    _quakeRenderRows = function(items) {
        if (!list) return;
        list.innerHTML = items.map(function(x){
            var m = parseFloat(x.mag);
            var cls = m >= 7 ? 'q-mag-severe' : m >= 5 ? 'q-mag-high' : m >= 3 ? 'q-mag-mid' : 'q-mag-low';
            var locShort = x.loc.length > 32 ? x.loc.substring(0,32)+'…' : x.loc;
            return '<div class="q-row">' +
                '<div class="q-row-top">' +
                '<span style="display:flex;align-items:center;gap:4px"><b class="q-mag ' + cls + '">M' + x.mag + '</b>' +
                '<span style="font-size:.82rem;font-weight:700;color:var(--text)">' + escHtml(locShort) + '</span>' +
                '</span>' +
                '<small class="q-time">' + x.time + '</small>' +
                '</div>' +
                (x.loc.length > 32 ? '<div class="q-loc" title="' + escHtml(x.loc) + '">' + escHtml(x.loc) + '</div>' : '') +
            '</div>';
        }).join('');
    };
}

/* ── EMSC WebSocket (anlık bildirim) ── */
var _emscWs = null;
var _emscConnected = false;
function startEMSCWebSocket() {
    if (_emscWs && (_emscWs.readyState === 0 || _emscWs.readyState === 1)) return;
    try {
        _emscWs = new WebSocket('wss://www.seismicportal.eu/standing_order/websocket');
        _emscWs.onopen = function() {
            _emscConnected = true;
        };
        _emscWs.onmessage = function(evt) {
            try {
                var msg = JSON.parse(evt.data);
                if (!msg || !msg.data || !msg.data.properties) return;
                var p = msg.data.properties;
                var mag = parseFloat(p.mag || p.magnitude || 0);
                var coords = msg.data.geometry ? msg.data.geometry.coordinates : [0,0];
                var lng = parseFloat(coords[0]);
                var lat = parseFloat(coords[1]);
                var loc = p.flynn_region || p.place || 'Bilinmeyen';
                var timeStr = new Date(p.time || p.lastupdate).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});

                /* Sadece Türkiye ve çevresi (35–43°N, 25–45°E) ve M1.5+ */
                var inTurkey = lat >= 35 && lat <= 43 && lng >= 25 && lng <= 45;
                if (mag < 1.5 || !inTurkey) return;

                /* Listeye ekle */
                if (_quakeRenderRows && _quakeSetUpdateTime) {
                    var list = document.getElementById('quakeList');
                    var existing = list ? list.querySelectorAll('.q-row') : [];
                    var newRow = document.createElement('div');
                    var mCls = mag >= 7 ? 'q-mag-severe' : mag >= 5 ? 'q-mag-high' : mag >= 3 ? 'q-mag-mid' : 'q-mag-low';
                    var locShort = loc.length > 32 ? loc.substring(0,32)+'…' : loc;
                    newRow.className = 'q-row q-row-new';
                    newRow.innerHTML =
                        '<div class="q-row-top">' +
                        '<span style="display:flex;align-items:center;gap:4px"><b class="q-mag ' + mCls + '">M' + mag.toFixed(1) + '</b>' +
                        '<span style="font-size:.82rem;font-weight:700;color:var(--text)">' + escHtml(locShort) + '</span>' +
                        '</span>' +
                        '<small class="q-time">' + timeStr + '</small>' +
                        '</div>' +
                        (loc.length > 32 ? '<div class="q-loc">' + escHtml(loc) + '</div>' : '');
                    if (list) {
                        list.insertBefore(newRow, list.firstChild);
                        /* En fazla 5 satır tut */
                        while (list.children.length > 5) list.removeChild(list.lastChild);
                    }
                    _quakeSetUpdateTime('EMSC ⚡');
                }

                /* Yakın büyük deprem uyarısı */
                checkNearbyDisasters([{ mag: mag, latitude: lat, longitude: lng,
                    title: loc, location: loc }]);

                /* M3+ ise toast */
                if (mag >= 3.0) {
                    showToast('🌍 M' + mag.toFixed(1) + ' — ' + loc.substring(0,30), 6000);
                }
            } catch(_) {}
        };
        _emscWs.onclose = function() {
            _emscConnected = false;
            /* 30 saniye sonra yeniden bağlan */
            setTimeout(startEMSCWebSocket, 30000);
        };
        _emscWs.onerror = function() {
            _emscConnected = false;
        };
    } catch(_) {}
}

/* ── Ana getQuakes: AFAD → Kandilli → USGS ── */
async function getQuakes() {
    if (!_quakeRenderRows) initQuakeHelpers();
    var list = document.getElementById('quakeList');
    var ok = false;

    /* Tarih aralığı: son 24 saat */
    function afadDateRange() {
        var end = new Date();
        var start = new Date(end - 24*60*60*1000);
        function fmt(d) {
            return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+
                   String(d.getDate()).padStart(2,'0')+'T'+
                   String(d.getHours()).padStart(2,'0')+':'+
                   String(d.getMinutes()).padStart(2,'0')+':00';
        }
        return { start: fmt(start), end: fmt(end) };
    }

    /* 1. AFAD (resmi Türkiye) */
    try {
        var dr = afadDateRange();
        var afadUrl = 'https://depremapi.afad.gov.tr/api/v1/event/filter?start=' +
            encodeURIComponent(dr.start) + '&end=' + encodeURIComponent(dr.end) +
            '&minmag=1.0&orderby=timedesc&limit=5';
        var r = await fetchWithTimeout(afadUrl, 7000);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        var d = await r.json();
        var q = Array.isArray(d) ? d : (Array.isArray(d.result) ? d.result : []);
        if (q.length) {
            _quakeRenderRows(q.slice(0,5).map(function(x){
                var dt = x.date || x.eventDate || '';
                var tm = dt.includes('T') ? dt.split('T')[1].substring(0,5) : (dt.split(' ')[1]||'').substring(0,5);
                var loc = x.location || x.province || x.district || '—';
                return { mag: parseFloat(x.magnitude||x.mag||0).toFixed(1), loc: loc, time: tm };
            }));
            _quakeSetUpdateTime('AFAD');
            checkNearbyDisasters(q.map(function(x){
                return { mag: x.magnitude||x.mag||0,
                         latitude: parseFloat(x.latitude||x.lat||0),
                         longitude: parseFloat(x.longitude||x.lon||0),
                         title: x.location||'—', location: x.location||'—' };
            }));
            ok = true;
        }
    } catch(_) {}

    /* 2. Kandilli (yedek) */
    if (!ok) {
        try {
            var r2 = await fetchWithTimeout('https://api.orhanaydogdu.com.tr/deprem/kandilli/live?limit=5', 7000);
            if (!r2.ok) throw new Error();
            var d2 = await r2.json();
            var q2 = Array.isArray(d2.result) ? d2.result : (Array.isArray(d2.data) ? d2.data : []);
            if (q2.length) {
                _quakeRenderRows(q2.slice(0,5).map(function(x){
                    var tm = (x.date||x.datetime||'').split(' ')[1] || '';
                    return { mag: parseFloat(x.mag||x.magnitude||0).toFixed(1),
                             loc: x.title||x.location||'—', time: tm };
                }));
                _quakeSetUpdateTime('KANDİLLİ');
                checkNearbyDisasters(q2.map(function(x){
                    return { mag: x.mag||x.magnitude||0, latitude: x.lat, longitude: x.lon,
                             title: x.title||x.location||'—', location: x.title||x.location||'—' };
                }));
                ok = true;
            }
        } catch(_) {}
    }

    /* 3. USGS global (son çare) */
    if (!ok) {
        try {
            var r3 = await fetchWithTimeout(
                'https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&minmagnitude=1.5&orderby=time&limit=5&minlatitude=35&maxlatitude=43&minlongitude=25&maxlongitude=45',
                8000);
            if (!r3.ok) throw new Error();
            var d3 = await r3.json();
            var f3 = (d3.features||[]).slice(0,5);
            if (f3.length) {
                _quakeRenderRows(f3.map(function(x){
                    var p = x.properties||{};
                    var tm = new Date(p.time).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
                    return { mag: parseFloat(p.mag||0).toFixed(1), loc: p.place||'—', time: tm };
                }));
                _quakeSetUpdateTime('USGS');
                checkNearbyDisasters(f3.map(function(x){
                    var p = x.properties||{};
                    var c = x.geometry ? x.geometry.coordinates : [0,0];
                    return { mag: p.mag||0, latitude: c[1], longitude: c[0],
                             place: p.place||'—', location: p.place||'—' };
                }));
                ok = true;
            }
        } catch(_) {}
    }

    if (!ok && list) {
        list.innerHTML = '<div style="font-size:.8rem;color:var(--sub);padding:4px 0">⚠️ Sismik ağa şu an ulaşılamıyor.</div>';
        if (document.getElementById('qSrc')) document.getElementById('qSrc').textContent = 'OFFLİNE';
    }
}

/* EMSC WebSocket başlat */
(function() {
    if (typeof WebSocket !== 'undefined') {
        /* Sayfa yüklendikten 2 sn sonra bağlan — diğer kaynaklar önce yüklensin */
        setTimeout(startEMSCWebSocket, 2000);
    }
})();

/* ===== DÜDÜK (Gerçekçi Düdük Sesi) ===== */
function toggleWhistle() {
    var btn = document.getElementById('wBtn');
    var txt = document.getElementById('wTxt');
    if (whistleOn) {
        /* Durdur */
        if (whistleCtx) {
            try {
                /* Tüm kayıtlı düğümleri kapat */
                if (whistleCtx._whistleNodes) {
                    whistleCtx._whistleNodes.forEach(function(n){ try{ n.stop(); n.disconnect(); }catch(_){} });
                }
            } catch(e) {}
        }
        whistleOn = false;
        txt.textContent = 'DÜDÜK';
        btn.style.cssText = '';
        return;
    }
    try {
        if (!whistleCtx || whistleCtx.state === 'closed') {
            whistleCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        function playRealWhistle() {
            var ctx = whistleCtx;
            var now = ctx.currentTime;
            var dur = 3.5;
            var nodes = [];
            whistleCtx._whistleNodes = nodes;

            /* === KATMAN 1: Ana düdük tonu (sine, ~3800 Hz) === */
            var mainOsc = ctx.createOscillator();
            var mainGain = ctx.createGain();
            mainOsc.type = 'sine';
            mainOsc.frequency.setValueAtTime(3820, now);
            /* Hafif frekans titremesi — gerçek düdük gibi */
            mainOsc.frequency.linearRampToValueAtTime(3860, now + 0.04);
            mainOsc.frequency.linearRampToValueAtTime(3800, now + 0.12);
            mainOsc.frequency.linearRampToValueAtTime(3840, now + 0.3);
            mainOsc.frequency.linearRampToValueAtTime(3820, now + dur - 0.4);
            mainOsc.frequency.linearRampToValueAtTime(3750, now + dur - 0.05);
            /* Zarf: hızlı attack, düz sustain, doğal decay */
            mainGain.gain.setValueAtTime(0, now);
            mainGain.gain.linearRampToValueAtTime(0.7, now + 0.04);
            mainGain.gain.setValueAtTime(0.68, now + 0.1);
            mainGain.gain.linearRampToValueAtTime(0.65, now + dur - 0.3);
            mainGain.gain.exponentialRampToValueAtTime(0.001, now + dur);
            mainOsc.connect(mainGain);

            /* === KATMAN 2: Harmonik (2. harmonik, ince dolgunluk) === */
            var harmOsc = ctx.createOscillator();
            var harmGain = ctx.createGain();
            harmOsc.type = 'sine';
            harmOsc.frequency.setValueAtTime(7640, now);
            harmOsc.frequency.linearRampToValueAtTime(7600, now + dur);
            harmGain.gain.setValueAtTime(0, now);
            harmGain.gain.linearRampToValueAtTime(0.12, now + 0.06);
            harmGain.gain.linearRampToValueAtTime(0.10, now + dur - 0.3);
            harmGain.gain.exponentialRampToValueAtTime(0.001, now + dur);
            harmOsc.connect(harmGain);

            /* === KATMAN 3: Nefes gürültüsü (beyaz gürültü filtreli) === */
            var bufSize = ctx.sampleRate * dur;
            var noiseBuffer = ctx.createBuffer(1, bufSize, ctx.sampleRate);
            var noiseData = noiseBuffer.getChannelData(0);
            for (var i = 0; i < bufSize; i++) { noiseData[i] = (Math.random() * 2 - 1); }
            var noiseSource = ctx.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            /* Bant geçiren filtre — sadece düdük frekans bandı */
            var bpFilter = ctx.createBiquadFilter();
            bpFilter.type = 'bandpass';
            bpFilter.frequency.value = 3800;
            bpFilter.Q.value = 12;
            var noiseGain = ctx.createGain();
            noiseGain.gain.setValueAtTime(0, now);
            noiseGain.gain.linearRampToValueAtTime(0.06, now + 0.03);
            noiseGain.gain.linearRampToValueAtTime(0.04, now + 0.2);
            noiseGain.gain.linearRampToValueAtTime(0.05, now + dur - 0.5);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + dur);
            noiseSource.connect(bpFilter);
            bpFilter.connect(noiseGain);

            /* === KATMAN 4: Rezonans (hafif vibrato ile gerçekçilik) === */
            var vibLfo = ctx.createOscillator();
            var vibGain = ctx.createGain();
            vibLfo.type = 'sine';
            vibLfo.frequency.value = 7.5;
            vibGain.gain.setValueAtTime(0, now);
            vibGain.gain.linearRampToValueAtTime(18, now + 0.15);
            vibGain.gain.setValueAtTime(14, now + dur - 0.3);
            vibGain.gain.linearRampToValueAtTime(0, now + dur);
            vibLfo.connect(vibGain);
            vibGain.connect(mainOsc.frequency);

            /* === MASTER GAIN + COMPRESSOR === */
            var masterGain = ctx.createGain();
            masterGain.gain.setValueAtTime(1.0, now);
            var comp = ctx.createDynamicsCompressor();
            comp.threshold.value = -6;
            comp.knee.value = 3;
            comp.ratio.value = 4;
            comp.attack.value = 0.003;
            comp.release.value = 0.1;

            mainGain.connect(masterGain);
            harmGain.connect(masterGain);
            noiseGain.connect(masterGain);
            masterGain.connect(comp);
            comp.connect(ctx.destination);

            /* Başlat */
            mainOsc.start(now); mainOsc.stop(now + dur);
            harmOsc.start(now); harmOsc.stop(now + dur);
            noiseSource.start(now); noiseSource.stop(now + dur);
            vibLfo.start(now); vibLfo.stop(now + dur);

            nodes.push(mainOsc, harmOsc, noiseSource, vibLfo);

            whistleOn = true;
            txt.textContent = 'DURDUR';
            btn.style.background = 'white';
            btn.style.color = '#000';

            /* Otomatik sıfırla — 3.5 sn sonra */
            mainOsc.onended = function() {
                if (whistleOn) {
                    whistleOn = false;
                    txt.textContent = 'DÜDÜK';
                    btn.style.cssText = '';
                }
            };
        }

        if (whistleCtx.state === 'suspended') {
            whistleCtx.resume().then(playRealWhistle).catch(function(e) {
                showToast('⚠️ Ses başlatılamadı: ' + e.message);
            });
        } else {
            playRealWhistle();
        }
    } catch(e) {
        showToast('⚠️ Ses hatası: ' + e.message);
    }
}

/* ===== ACİL DURUM TETİKLEME ===== */
function triggerEmergencyAlert(message, duration) {
    try {
        if (!whistleCtx || whistleCtx.state === 'closed') {
            whistleCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (whistleCtx.state === 'suspended') whistleCtx.resume().catch(function(){});
        var sirenOsc = whistleCtx.createOscillator();
        var sirenGain = whistleCtx.createGain();
        sirenOsc.connect(sirenGain);
        sirenGain.connect(whistleCtx.destination);
        sirenOsc.type = 'square';
        var sirenStartTime = whistleCtx.currentTime;
        var sirenDuration = 3.5;
        sirenGain.gain.setValueAtTime(0, whistleCtx.currentTime);
        sirenGain.gain.linearRampToValueAtTime(1.0, whistleCtx.currentTime + 0.1);
        for (var i = 0; i < 7; i++) {
            var timeOffset = i * 0.5;
            if (timeOffset < sirenDuration) {
                sirenOsc.frequency.linearRampToValueAtTime(3500, sirenStartTime + timeOffset + 0.25);
                sirenOsc.frequency.linearRampToValueAtTime(2500, sirenStartTime + timeOffset + 0.5);
            }
        }
        sirenOsc.frequency.setValueAtTime(2500, whistleCtx.currentTime);
        sirenGain.gain.exponentialRampToValueAtTime(0.01, whistleCtx.currentTime + sirenDuration + 0.2);
        sirenOsc.start();
        sirenOsc.stop(whistleCtx.currentTime + sirenDuration + 0.2);
    } catch(_) {}
    showBreakingNews(message, duration || 15000, true);
    if (navigator.vibrate) {
        try { navigator.vibrate([500, 300, 500, 200, 500]); } catch(_) {}
    }
}
function showBreakingNews(message, duration, isFromEmergencyAlert) {
    var banner = document.getElementById('breakingNews');
    var header = document.querySelector('header');
    banner.textContent = message;
    banner.classList.add('active');
    header.classList.add('news-active');
    if (!isFromEmergencyAlert) {
        try {
            var ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') ctx.resume().catch(function(){});
            for (var i = 0; i < 3; i++) {
                (function(idx) {
                    setTimeout(function() {
                        var osc = ctx.createOscillator();
                        var gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(1600 + idx*200, ctx.currentTime);
                        gain.gain.setValueAtTime(0.8, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.25);
                    }, idx * 300);
                })(i);
            }
        } catch(_) {}
    }
    if (!duration) duration = 12000;
    setTimeout(function() {
        banner.classList.remove('active');
        header.classList.remove('news-active');
    }, duration);
}

/* ===== TIBBİ NOTLAR ===== */
function saveMedical() { try{ localStorage.setItem('vitalium_medical_notes', document.getElementById('medNotes').value); }catch(_){} }
function loadMedical()  { try{ var v=localStorage.getItem('vitalium_medical_notes'); if(v!==null) document.getElementById('medNotes').value=v; }catch(_){} }

/* ===== ACİL KONTAK ===== */
function call(number) {
    /* Onay animasyonu */
    var cpEl = document.getElementById('cp' + number);
    if (cpEl) {
        cpEl.classList.add('show');
        setTimeout(function() { cpEl.classList.remove('show'); }, 1500);
    }
    window.location.href = 'tel:' + number;
}
function addContactField() {
    var container = document.getElementById('customContacts');
    var div = document.createElement('div');
    div.style.cssText = 'display:flex;gap:8px;align-items:center';
    var input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Ad ve numara (örn: Doktor 5551234567)';
    input.style.cssText = 'flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:rgba(255,255,255,.05);color:var(--text);font-size:.85rem';
    input.onchange = saveCustomContacts;
    var btn = document.createElement('button');
    btn.textContent = '✕';
    btn.style.cssText = 'width:40px;padding:10px;border:1px solid var(--border);background:none;color:var(--sub);border-radius:8px;cursor:pointer;font-weight:700';
    btn.onclick = function() { div.remove(); saveCustomContacts(); };
    div.appendChild(input);
    div.appendChild(btn);
    container.appendChild(div);
}
function saveCustomContacts() {
    try {
        var inputs = document.querySelectorAll('#customContacts input');
        var contacts = [];
        inputs.forEach(function(inp) { if (inp.value.trim()) contacts.push(inp.value); });
        localStorage.setItem('vitalium_custom_contacts', JSON.stringify(contacts));
    } catch(_) {}
}
function loadCustomContacts() {
    try {
        var saved = localStorage.getItem('vitalium_custom_contacts');
        if (saved) {
            var contacts = JSON.parse(saved);
            contacts.forEach(function() { addContactField(); });
            var inputs = document.querySelectorAll('#customContacts input');
            inputs.forEach(function(inp, idx) { inp.value = contacts[idx] || ''; });
        }
    } catch(_) {}
}

/* ===== CPR METRONOM ===== */
var metroRunning  = false;
var metroStep     = 0;
var metroBPM      = 110;
var metroPeriod   = 60.0 / metroBPM;
var metroNextTime = 0;
var metroAudioCtx = null;
var LOOKAHEAD_MS  = 25;
var SCHEDULE_AHEAD= 0.12;
function getMetroCtx() {
    if (!metroAudioCtx || metroAudioCtx.state === 'closed') {
        try { metroAudioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch(e) { return null; }
    }
    if (metroAudioCtx.state === 'suspended') metroAudioCtx.resume().catch(function(){});
    return metroAudioCtx;
}
function scheduleBeep(atTime) {
    var ctx = getMetroCtx();
    if (!ctx) return;
    var osc  = ctx.createOscillator();
    var gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, atTime);
    gain.gain.setValueAtTime(0.55, atTime);
    gain.gain.exponentialRampToValueAtTime(0.001, atTime + 0.09);
    osc.start(atTime);
    osc.stop(atTime + 0.10);
    osc.onended = function() { try{ osc.disconnect(); gain.disconnect(); }catch(_){} };
}
function metroVisualTick() {
    metroStep++;
    var ring  = document.getElementById('metroRing');
    var count = document.getElementById('metroCount');
    var sub   = document.getElementById('metroSub');
    count.textContent = metroStep;
    count.classList.add('flash');
    setTimeout(function(){ count.classList.remove('flash'); }, 120);
    ring.classList.add('active');
    setTimeout(function(){ ring.classList.remove('active'); }, 200);
    if (navigator.vibrate) { try { navigator.vibrate(22); } catch(_){} }
    if (metroStep > 0 && metroStep % 30 === 0) {
        sub.textContent = metroStep + ' basış — ' + Math.round(metroStep / metroBPM * 60) + ' saniye';
    }
}
var metroSchedulerTimer = null;
function metroScheduler() {
    var ctx = getMetroCtx();
    if (!ctx || !metroRunning) return;
    while (metroNextTime < ctx.currentTime + SCHEDULE_AHEAD) {
        scheduleBeep(metroNextTime);
        var delay = Math.max(0, (metroNextTime - ctx.currentTime) * 1000);
        (function(){ setTimeout(metroVisualTick, delay); })();
        metroNextTime += metroPeriod;
    }
}
function metroStart() {
    if (metroRunning) return;
    var ctx = getMetroCtx();
    if (!ctx) { showToast('⚠️ Ses sistemi başlatılamadı.'); return; }
    metroRunning  = true;
    metroNextTime = ctx.currentTime + 0.05;
    document.getElementById('metroStartBtn').style.display = 'none';
    document.getElementById('metroStopBtn').style.display  = 'block';
    document.getElementById('metroSub').textContent = 'Ritme göre göğse basın…';
    metroScheduler();
    metroSchedulerTimer = setInterval(metroScheduler, LOOKAHEAD_MS);
}
function metroStop() {
    if (!metroRunning) return;
    metroRunning = false;
    clearInterval(metroSchedulerTimer);
    metroSchedulerTimer = null;
    if (metroAudioCtx && metroAudioCtx.state === 'running') {
        metroAudioCtx.suspend().catch(function(){});
    }
    document.getElementById('metroStartBtn').style.display = 'block';
    document.getElementById('metroStopBtn').style.display  = 'none';
    document.getElementById('metroSub').textContent = 'Durduruldu — ' + metroStep + ' basış yapıldı';
}
function metroReset() {
    metroStop();
    metroStep = 0;
    document.getElementById('metroCount').textContent = '0';
    document.getElementById('metroSub').textContent   = 'Başlat\'a bas, ritme göre bastır';
    document.getElementById('metroRing').classList.remove('active');
}

/* ===== NABIZ SAYACI ===== */
var pulseTimes   = [];
var pulseTimeout = null;
function pulseTap() {
    var now = Date.now();
    pulseTimes.push(now);
    pulseTimes = pulseTimes.filter(function(t){ return now - t < 10000; });
    var btn = document.getElementById('pulseTapBtn');
    btn.classList.add('beat');
    setTimeout(function(){ btn.classList.remove('beat'); }, 200);
    document.getElementById('pulseTaps').textContent = pulseTimes.length;
    if (pulseTimes.length >= 2) {
        var intervals = [];
        for (var i = 1; i < pulseTimes.length; i++) {
            intervals.push(pulseTimes[i] - pulseTimes[i-1]);
        }
        var avgInterval = intervals.reduce(function(a,b){ return a+b; }, 0) / intervals.length;
        var bpm = Math.round(60000 / avgInterval);
        bpm = Math.max(20, Math.min(250, bpm));
        document.getElementById('pulseBPM').textContent = bpm;
        var status, statusColor;
        if (bpm < 60)  { status = 'Düşük';      statusColor = '#3b82f6'; }
        else if (bpm <= 100) { status = 'Normal';     statusColor = '#10b981'; }
        else if (bpm <= 120) { status = 'Yüksek';    statusColor = '#f59e0b'; }
        else                 { status = 'Çok Yüksek'; statusColor = '#e11d48'; }
        var el = document.getElementById('pulseStatus');
        el.textContent = status;
        el.style.color = statusColor;
    }
    clearTimeout(pulseTimeout);
    pulseTimeout = setTimeout(function() {
        if (pulseTimes.length >= 2) showToast('💗 Ölçüm tamamlandı!');
    }, 4000);
}
function pulseReset() {
    pulseTimes = [];
    clearTimeout(pulseTimeout);
    document.getElementById('pulseBPM').textContent    = '—';
    document.getElementById('pulseTaps').textContent   = '0';
    document.getElementById('pulseStatus').textContent = '—';
    document.getElementById('pulseStatus').style.color = '';
}

/* ===== HIZLI ACİL REHBER ===== */
function openQuickEmergency() {
    var quickCards = [0, 1, 4, 9, 14, 16];
    var grid = document.getElementById('quickEmergencyGrid');
    grid.innerHTML = quickCards.map(function(idx) {
        var g = DATA[idx];
        var title = typeof g.t === 'object' ? (g.t[currentLang] || g.t.tr) : g.t;
        return '<button onclick="openModal('+idx+'); closeQuickEmergency()" style="' +
               'width:100%;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:14px;' +
               'text-align:left;cursor:pointer;transition:border-color .2s;display:flex;align-items:center;gap:14px;' +
               '"><div style="font-size:1.8rem;line-height:1;flex-shrink:0">'+g.i+'</div>' +
               '<div style="font-weight:700;color:var(--text);font-size:.92rem">'+escHtml(title)+'</div>' +
               '</button>';
    }).join('');
    document.getElementById('quickEmergencyOverlay').style.display = 'flex';
}
function closeQuickEmergency() {
    document.getElementById('quickEmergencyOverlay').style.display = 'none';
}

/* ===== SOS ===== */
function triggerSOS() {
    if (!navigator.geolocation) {
        showToast('⚠️ Cihazınız konum hizmetini desteklemiyor.'); return;
    }
    showToast('📍 Konum alınıyor…', 5000);
    navigator.geolocation.getCurrentPosition(
        function(pos) {
            var lat = pos.coords.latitude, lng = pos.coords.longitude;
            var mapUrl = 'https://www.google.com/maps?q=' + lat + ',' + lng;
            var msgBody = 'ACİL DURUM! Lütfen yardım edin. Konumum: ' + mapUrl;
            var ua = navigator.userAgent;
            var iosDevice = /iPhone|iPad|iPod/i.test(ua);
            var androidDevice = /Android/i.test(ua);
            if (iosDevice || androidDevice) {
                var encoded = encodeURIComponent(msgBody);
                window.location.href = iosDevice ? 'sms:&body=' + encoded : 'sms:?body=' + encoded;
            } else {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(msgBody).then(function(){
                        showToast('📋 Acil mesaj panoya kopyalandı! Birine gönderin.', 5000);
                    }).catch(function(){
                        prompt('Acil mesajı kopyalayın:', msgBody);
                    });
                } else {
                    prompt('Acil mesajı kopyalayın:', msgBody);
                }
            }
        },
        function(err) {
            var msgs = {1:'⚠️ Konum izni reddedildi.',2:'⚠️ Konum alınamadı — GPS açık mı?',3:'⚠️ Konum zaman aşımına uğradı.'};
            showToast(msgs[err.code] || '⚠️ Konum hatası.');
        },
        { timeout: 10000, maximumAge: 0, enableHighAccuracy: true }
    );
}

/* ===== ACİL DURUM ÇANTASI ===== */
var BAG_ITEMS = [
    {id:'water',    icon:'💧', label:'Su (kişi başı 3 lt/gün, 3 gün)',         cat:'Temel'},
    {id:'food',     icon:'🥫', label:'Kuru/konserve gıda (3 günlük)',           cat:'Temel'},
    {id:'torch',    icon:'🔦', label:'El feneri + yedek pil',                   cat:'Temel'},
    {id:'radio',    icon:'📻', label:'Pilli taşınabilir radyo',                 cat:'Temel'},
    {id:'whistle',  icon:'📣', label:'Düdük (kurtarma için)',                   cat:'Temel'},
    {id:'blanket',  icon:'🧣', label:'Termal battaniye / uyku tulumu',          cat:'Temel'},
    {id:'firstaid', icon:'🩹', label:'İlk yardım seti (bandaj, antiseptik)',    cat:'Sağlık'},
    {id:'meds',     icon:'💊', label:'Kişisel ilaçlar (7 günlük)',              cat:'Sağlık'},
    {id:'docs',     icon:'📄', label:'Kimlik, pasaport, önemli belgeler (kopya)',cat:'Belgeler'},
    {id:'cash',     icon:'💵', label:'Nakit para (ATM çalışmayabilir)',          cat:'Belgeler'},
    {id:'phone',    icon:'🔋', label:'Powerbank + şarj kablosu',                cat:'İletişim'},
    {id:'contact',  icon:'📋', label:'Acil kontak listesi (kağıda yazılı)',     cat:'İletişim'},
    {id:'clothes',  icon:'👕', label:'Yedek giysiler + yağmurluk',             cat:'Giysi'},
    {id:'shoes',    icon:'👟', label:'Sağlam ayakkabı / bot',                  cat:'Giysi'},
    {id:'mask',     icon:'😷', label:'N95 maske (yangın/toz için)',             cat:'Sağlık'},
    {id:'knife',    icon:'🔪', label:'Çakı / çok amaçlı alet',                cat:'Araç'},
    {id:'rope',     icon:'🪢', label:'Sağlam ip (10 m)',                        cat:'Araç'},
    {id:'lighter',  icon:'🔥', label:'Çakmak / kibritler (su geçirmez)',        cat:'Araç'},
    {id:'soap',     icon:'🧼', label:'Küçük sabun + hijyen malzemeleri',        cat:'Hijyen'},
    {id:'map',      icon:'🗺️', label:'Bölge kağıt haritası (GPS bağımsız)',    cat:'Temel'}
];
var bagChecked = {};

function bagLoad() {
    try {
        var saved = localStorage.getItem('vitalium_bag');
        if (saved) bagChecked = JSON.parse(saved);
    } catch(_) {}
}
function bagSave() {
    try { localStorage.setItem('vitalium_bag', JSON.stringify(bagChecked)); } catch(_) {}
}
function bagRender() {
    var grid = document.getElementById('bagGrid');
    if (!grid) return;
    /* Kategorilere göre grupla */
    var cats = {};
    BAG_ITEMS.forEach(function(item) {
        if (!cats[item.cat]) cats[item.cat] = [];
        cats[item.cat].push(item);
    });
    var catOrder = ['Temel', 'Sağlık', 'İletişim', 'Belgeler', 'Giysi', 'Araç', 'Hijyen'];
    var html = '';
    catOrder.forEach(function(cat) {
        if (!cats[cat]) return;
        html += '<div class="bag-category">';
        html += '<span class="bag-cat-label">' + cat + '</span>';
        html += '<div class="bag-cat-grid">';
        cats[cat].forEach(function(item) {
            var checked = !!bagChecked[item.id];
            html += '<div class="bag-item' + (checked ? ' checked' : '') + '" onclick="bagToggle(\'' + item.id + '\')">' +
                '<div class="bag-check">' + (checked ? '✓' : '') + '</div>' +
                '<span class="bag-icon">' + item.icon + '</span>' +
                '<span class="bag-label">' + item.label + '</span>' +
                '</div>';
        });
        html += '</div></div>';
    });
    grid.innerHTML = html;
    bagUpdateProgress();
}
function bagToggle(id) {
    bagChecked[id] = !bagChecked[id];
    bagSave();
    bagRender();
}
function bagReset() {
    bagChecked = {};
    bagSave();
    bagRender();
    showToast('↺ Çanta listesi sıfırlandı');
}
function bagUpdateProgress() {
    var total = BAG_ITEMS.length;
    var done = Object.keys(bagChecked).filter(function(k){ return bagChecked[k]; }).length;
    var pct = Math.round(done / total * 100);
    var countEl = document.getElementById('bagCount');
    var fillEl = document.getElementById('bagBarFill');
    var pctEl = document.getElementById('bagPct');
    if (countEl) countEl.textContent = done + '/' + total;
    if (fillEl)  fillEl.style.width = pct + '%';
    if (pctEl)   pctEl.textContent = '%' + pct;
}

/* ===== HAVA DURUMU (Open-Meteo - ücretsiz, anahtar gerekmez) ===== */
var WMO_ICONS = {
    0:'☀️',1:'🌤️',2:'⛅',3:'☁️',
    45:'🌫️',48:'🌫️',
    51:'🌦️',53:'🌦️',55:'🌧️',61:'🌧️',63:'🌧️',65:'🌧️',
    71:'🌨️',73:'❄️',75:'❄️',77:'🌨️',
    80:'🌦️',81:'🌧️',82:'⛈️',
    95:'⛈️',96:'⛈️',99:'⛈️'
};
var WMO_DESC = {
    0:'Açık',1:'Az bulutlu',2:'Parçalı bulutlu',3:'Kapalı',
    45:'Sisli',48:'Kırağılı sis',
    51:'Hafif çisenti',53:'Çisenti',55:'Yoğun çisenti',
    61:'Hafif yağmur',63:'Yağmur',65:'Yoğun yağmur',
    71:'Hafif kar',73:'Kar',75:'Yoğun kar',77:'Kar taneleri',
    80:'Hafif sağanak',81:'Sağanak',82:'Şiddetli sağanak',
    95:'Fırtına',96:'Dolu',99:'Yoğun dolu'
};
function fetchWeather() {
    var box = document.getElementById('weatherContent');
    if (!box) return;
    box.innerHTML = '<span style="font-size:1.2rem">📍</span><span style="color:var(--sub);font-size:.8rem"> Konum alınıyor…</span>';

    getLocationWithFallback(
        function(loc) {
            var lat = loc.latitude.toFixed ? loc.latitude.toFixed(4) : loc.latitude;
            var lng = loc.longitude.toFixed ? loc.longitude.toFixed(4) : loc.longitude;
            var ipCity = loc.city || '';
            var byIP = loc.byIP || false;

            var weatherUrl = 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lng +
                      '&current=temperature_2m,apparent_temperature,precipitation,windspeed_10m,weathercode' +
                      '&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode' +
                      '&timezone=auto&forecast_days=3';

            /* IP ile geldiyse zaten şehir bilgisi var, değilse Nominatim'den al */
            var geoPromise = (ipCity && byIP)
                ? Promise.resolve(null)
                : fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&zoom=10&accept-language=tr', {headers:{'User-Agent':'VitaliumPRO/1.0'}})
                    .then(function(r){ return r.json(); })
                    .catch(function(){ return null; });

            Promise.all([
                fetch(weatherUrl).then(function(r){ return r.json(); }),
                geoPromise
            ]).then(function(results) {
                var weatherData = results[0];
                var geoData = results[1];
                var cityName = ipCity;
                if (!cityName && geoData && geoData.address) {
                    cityName = geoData.address.city || geoData.address.town || geoData.address.village || geoData.address.county || '';
                }
                renderWeather(weatherData, lat, lng, cityName, byIP);
            }).catch(function() {
                box.innerHTML = '<span style="color:var(--sub);font-size:.8rem">⚠️ Hava verisi alınamadı</span>';
            });
        },
        function() {
            box.innerHTML = '<span style="color:var(--sub);font-size:.8rem">📍 Konum alınamadı — internet bağlantısını kontrol edin</span>';
        },
        {timeout: 8000, maximumAge: 300000, enableHighAccuracy: false}
    );
}
function renderWeather(d, lat, lng, cityName, byIP) {
    var box = document.getElementById('weatherContent');
    if (!box || !d.current) return;
    var c = d.current;
    var temp    = Math.round(c.temperature_2m);
    var feels   = Math.round(c.apparent_temperature);
    var wind    = Math.round(c.windspeed_10m);
    var precip  = c.precipitation || 0;
    var wcode   = c.weathercode;
    var icon    = WMO_ICONS[wcode] || '🌡️';
    var desc    = WMO_DESC[wcode]  || 'Bilinmiyor';
    var alertHTML = '';
    if (temp >= 38)       alertHTML = '<div class="weather-alert hot">🔥 Aşırı sıcak uyarısı! Güneş çarpmasına dikkat edin, bol su için.</div>';
    else if (temp >= 32)  alertHTML = '<div class="weather-alert hot">☀️ Sıcak hava — güneşte uzun süre kalmayın.</div>';
    else if (temp <= -5)  alertHTML = '<div class="weather-alert cold">🥶 Dondurucu soğuk — hipotermi riskine karşı sıcak giyinin.</div>';
    else if (temp <= 5)   alertHTML = '<div class="weather-alert cold">🧣 Soğuk hava — katmanlı giyim önerilir.</div>';
    else if (wind >= 70)  alertHTML = '<div class="weather-alert wind">💨 Kuvvetli fırtına! Ağır araçlarla seyahat etmeyin.</div>';
    else if (wind >= 40)  alertHTML = '<div class="weather-alert wind">💨 Rüzgarlı hava — açık çatılar, kapılar tehlikeli.</div>';
    else if (precip > 10) alertHTML = '<div class="weather-alert rain">🌧️ Yoğun yağış — sel ve su baskınına dikkat edin.</div>';
    else if (precip > 2)  alertHTML = '<div class="weather-alert rain">🌦️ Yağmur bekleniyor — şemsiye bulundurun.</div>';
    else                   alertHTML = '<div class="weather-alert ok">✅ Normal hava koşulları</div>';
    var daily = '';
    if (d.daily && d.daily.temperature_2m_max) {
        var days = ['Bugün','Yarın','2 gün'];
        daily = '<div class="weather-details">' + d.daily.temperature_2m_max.slice(0,3).map(function(mx, i) {
            var mn = d.daily.temperature_2m_min[i];
            var dc = d.daily.weathercode[i];
            var di = WMO_ICONS[dc] || '🌡️';
            return '<div class="weather-chip">' + di + ' ' + days[i] + ' ' + Math.round(mn) + '–' + Math.round(mx) + '°</div>';
        }).join('') + '</div>';
    }
    var now = new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    var locIcon = byIP ? '🌐' : '📍';
    var locSuffix = byIP ? ' (IP bazlı)' : '';
    var locationLine = cityName
        ? '<div class="weather-loc">' + locIcon + ' ' + escHtml(cityName) + locSuffix + ' · ' + now + '</div>'
        : '<div class="weather-loc">' + locIcon + ' ' + lat + ', ' + lng + locSuffix + ' · ' + now + '</div>';
    box.innerHTML =
        '<div class="weather-row">' +
        '<div class="weather-icon">' + icon + '</div>' +
        '<div class="weather-info">' +
        '<div class="weather-val">' + temp + '°C</div>' +
        '<div class="weather-desc">' + desc + '</div>' +
        '<div class="weather-loc">Hissedilen: ' + feels + '°C · Rüzgar: ' + wind + ' km/s</div>' +
        '</div>' +
        '</div>' +
        locationLine +
        alertHTML + daily;
}

/* ===== YENİ: ONLİNE/OFFLİNE ALGILAMA ===== */
(function() {
    var banner = document.getElementById('offlineBanner');
    var header = document.querySelector('header');
    function updateOnlineStatus() {
        if (!navigator.onLine) {
            banner.classList.add('visible');
            if (header) header.classList.add('offline-active');
        } else {
            banner.classList.remove('visible');
            if (header) header.classList.remove('offline-active');
        }
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
})();

/* ===== BAŞLAT ===== */
render();
loadMedical();
loadCustomContacts();
requestUserLocation();
getQuakes();
setInterval(getQuakes, 45000);
requestNotificationPermission();
updateBloodGroupButton();
loadA11y();
applyTranslations();
syncThemeBtn();
bagLoad();
bagRender();
fetchWeather();

document.querySelectorAll('.blood-option').forEach(btn => {
    btn.addEventListener('click', function() { selectBloodGroup(this.dataset.group); });
});
document.querySelectorAll('.rh-option').forEach(btn => {
    btn.addEventListener('click', function() { selectRh(this.dataset.rh); });
});
document.getElementById('saveBloodGroupBtn').addEventListener('click', saveBloodGroup);

document.getElementById('mainOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});
document.getElementById('quickEmergencyOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeQuickEmergency();
});
document.getElementById('bloodGroupOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeBloodGroupModal();
});
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});

/* ===== MANIFEST + SERVICE WORKER ===== */
var swCode = [
"var ICON_192 = null;",
"var ICON_512 = null;",
"function drawIconSW(size){",
"  var c=new OffscreenCanvas(size,size);",
"  var ctx=c.getContext('2d');",
"  var r=Math.round(size*0.22);",
"  ctx.beginPath();ctx.moveTo(r,0);ctx.lineTo(size-r,0);",
"  ctx.arcTo(size,0,size,r,r);ctx.lineTo(size,size-r);",
"  ctx.arcTo(size,size,size-r,size,r);ctx.lineTo(r,size);",
"  ctx.arcTo(0,size,0,size-r,r);ctx.lineTo(0,r);",
"  ctx.arcTo(0,0,r,0,r);ctx.closePath();",
"  var g=ctx.createLinearGradient(0,0,size,size);",
"  g.addColorStop(0,'#e11d48');g.addColorStop(1,'#be123c');",
"  ctx.fillStyle=g;ctx.fill();",
"  ctx.save();ctx.translate(size*0.5,size*0.53);",
"  var h=size*0.36;",
"  ctx.beginPath();",
"  ctx.moveTo(0,h*0.35);",
"  ctx.bezierCurveTo(-h*0.1,h*0.1,-h*0.7,-h*0.4,-h,0);",
"  ctx.bezierCurveTo(-h*1.35,h*0.5,0,h*1.05,0,h*1.05);",
"  ctx.bezierCurveTo(0,h*1.05,h*1.35,h*0.5,h,0);",
"  ctx.bezierCurveTo(h*0.7,-h*0.4,h*0.1,h*0.1,0,h*0.35);",
"  ctx.closePath();ctx.fillStyle='#fff';ctx.fill();ctx.restore();",
"  return c.convertToBlob({type:'image/png'});",
"}",
"self.addEventListener('install',function(e){self.skipWaiting();});",
"self.addEventListener('activate',function(e){self.clients.claim();});",
"self.addEventListener('fetch',function(e){",
"  var url=e.request.url;",
"  if(url.indexOf('vitalium-icon-192.png')>-1){",
"    e.respondWith(drawIconSW(192).then(function(blob){return new Response(blob,{headers:{'Content-Type':'image/png','Cache-Control':'public,max-age=86400'}});}));",
"    return;",
"  }",
"  if(url.indexOf('vitalium-icon-512.png')>-1){",
"    e.respondWith(drawIconSW(512).then(function(blob){return new Response(blob,{headers:{'Content-Type':'image/png','Cache-Control':'public,max-age=86400'}});}));",
"    return;",
"  }",
"});",
"self.addEventListener('push',function(event){if(!event.data)return;var data=event.data.json();var options={body:data.body||'VITALIUM Uyarısı',icon:'./vitalium-icon-192.png',badge:'./vitalium-icon-192.png',tag:data.tag||'vitalium-alert',requireInteraction:true,vibrate:[500,300,500]};event.waitUntil(self.registration.showNotification(data.title||'🚨 VITALIUM UYARISI',options));});",
"self.addEventListener('notificationclick',function(event){event.notification.close();event.waitUntil(clients.matchAll({type:'window'}).then(function(clientList){if(clientList.length>0){return clientList[0].focus();}return clients.openWindow('./');}));});"
].join('\n');

var swRegistered = false;
(function() {
    if (!('serviceWorker' in navigator)) { buildAndInjectManifest(false); return; }
    /* Blob URL protokolü bazı ortamlarda SW kaydını desteklemiyor — sessizce atla */
    try {
        var swBlob = new Blob([swCode], {type: 'application/javascript'});
        var swUrl = URL.createObjectURL(swBlob);
        /* blob: protokol desteğini test et */
        if (!swUrl || swUrl.indexOf('blob:') !== 0) { buildAndInjectManifest(false); return; }
        navigator.serviceWorker.register(swUrl, {scope: './'}).then(function(reg) {
            swRegistered = true;
            buildAndInjectManifest(true);
        }).catch(function() {
            /* Sessizce atla — konsola hata yazdırmıyoruz */
            buildAndInjectManifest(false);
        });
    } catch(e) {
        buildAndInjectManifest(false);
    }
})();

function buildAndInjectManifest(hasSW) {
    var icons;
    if (hasSW) {
        icons = [
            {"src": "./vitalium-icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any"},
            {"src": "./vitalium-icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable"}
        ];
    } else if (window._pwaIcons && window._pwaIcons.png192) {
        icons = [
            {"src": window._pwaIcons.png192, "sizes": "192x192", "type": "image/png", "purpose": "any"},
            {"src": window._pwaIcons.png512, "sizes": "512x512", "type": "image/png", "purpose": "any maskable"}
        ];
    } else {
        icons = [
            {"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23e11d48' rx='48'/%3E%3Cpath d='M96 155C52 118 32 96 32 72c0-18 14-32 29-32 10 0 20 7 35 22 15-15 25-22 35-22 15 0 29 14 29 32 0 24-20 46-64 83Z' fill='white'/%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml","purpose":"any"}
        ];
    }
    var manifestData = {
        "name": "VITALIUM PRO - Acil Durum Rehberi",
        "short_name": "VITALIUM",
        "description": "Deprem, afet ve acil durumlar için kapsamlı bilgi ve rehberlik",
        "start_url": "./",
        "scope": "./",
        "display": "standalone",
        "orientation": "portrait-primary",
        "theme_color": "#e11d48",
        "background_color": "#020617",
        "icons": icons,
        "categories": ["medical","health"],
        "shortcuts": [{"name":"SOS Ara","short_name":"SOS","url":"./?action=sos","icons":[{"src":"./vitalium-icon-192.png","sizes":"192x192","type":"image/png"}]}]
    };
    if (!document.querySelector('link[rel="manifest"]')) {
        var b = new Blob([JSON.stringify(manifestData)], {type:'application/json'});
        var u = URL.createObjectURL(b);
        var l = document.createElement('link');
        l.rel = 'manifest'; l.href = u;
        document.head.appendChild(l);
    }
}

/* ===== ANA SAYFAYA EKLE ===== */
var deferredInstallPrompt = null;
var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
var isAndroid = /Android/i.test(navigator.userAgent);
var isInStandaloneMode = (window.navigator.standalone === true) ||
                         (window.matchMedia('(display-mode: standalone)').matches);
if (isInStandaloneMode) {
    document.getElementById('installBar').style.display = 'none';
}
window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredInstallPrompt = e;
});
window.addEventListener('appinstalled', function() {
    document.getElementById('installBar').style.display = 'none';
    showToast('✅ Uygulama ana sayfaya eklendi!', 3500);
});
function installApp() {
    if (deferredInstallPrompt) {
        deferredInstallPrompt.prompt();
        deferredInstallPrompt.userChoice.then(function(r) {
            if (r.outcome === 'accepted') {
                document.getElementById('installBar').style.display = 'none';
            }
            deferredInstallPrompt = null;
        });
    } else if (isIOS) {
        document.getElementById('iosGuide').classList.add('on');
    } else if (isAndroid) {
        document.getElementById('androidGuide').classList.add('on');
    } else {
        document.getElementById('desktopGuide').classList.add('on');
    }
}
document.getElementById('iosGuide').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('on');
});
document.getElementById('androidGuide').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('on');
});
document.getElementById('desktopGuide').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('on');
});

if (synth) {
    loadVoices();
    if (typeof synth.onvoiceschanged !== 'undefined') {
        synth.onvoiceschanged = loadVoices;
    }
    setTimeout(loadVoices, 500);
}
</script>

</body>
</html>